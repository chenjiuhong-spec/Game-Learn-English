<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯çƒè¯­éŸ³ä¹‹æ—… - è€å¹´äººè‹±æ–‡å­¦ä¹ æ¸¸æˆ</title>
    
    <!-- PWA: é“¾æ¥åˆ°åº”ç”¨æ¸…å•æ–‡ä»¶ -->
    <link rel="manifest" href="manifest.webmanifest">
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons (ç”¨äºå¤§å›¾æ ‡) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ Confetti æ’’èŠ±æ•ˆæœåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /*
        * å­—ä½“åŠ è½½ä¼˜åŒ–ï¼š
        * ä¾èµ–æœ¬åœ°ç³»ç»Ÿå­—ä½“ï¼Œå¹¶å°† 'Noto Sans TC', 'Inter' ä½œä¸ºé¦–é€‰ã€‚
        */
        :root {
            --color-primary: #1e3a8a; /* æ·±è“è‰² */
            --color-secondary: #3b82f6; /* äº®è“è‰² */
            --color-success: #10b981; /* ç»¿è‰² */
            --color-warning: #f59e0b; /* é»„è‰² */
            --color-danger: #ef4444; /* çº¢è‰² */
            --color-background: #f0f9ff; /* æµ…è“è‰²èƒŒæ™¯ */
        }
        body {
            /* ä¾èµ–ç³»ç»Ÿå­—ä½“ï¼Œå¹¶ä¼˜å…ˆä½¿ç”¨ Noto Sans TC å’Œ Inter ä½œä¸ºæœŸæœ›çš„é£æ ¼ */
            font-family: 'Noto Sans TC', 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--color-background);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        /* ç¡®ä¿æ‰€æœ‰å…ƒç´ åœ¨ç§»åŠ¨ç«¯éƒ½è¶³å¤Ÿå¤§ */
        .text-xl { font-size: 1.5rem; }
        .text-2xl { font-size: 1.875rem; }
        .text-3xl { font-size: 2.25rem; }
        .text-4xl { font-size: 2.5rem; }
        .btn-xl {
            padding: 1.5rem 2.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 1.5rem;
            transition: transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-xl:active {
            transform: scale(0.98);
        }
        .card {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        /* éº¦å…‹é£åŠ¨æ€æ•ˆæœ */
        #mic-icon {
            animation: pulse 1.5s infinite;
        }
        .listening #mic-icon {
            animation: breathe 1s infinite alternate;
            color: var(--color-danger);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes breathe {
            0% { transform: scale(0.9); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }
        /* è¯„åˆ†åé¦ˆå¼¹çª—åŠ¨ç”» */
        .modal-enter {
            opacity: 0;
            transform: scale(0.8);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s ease-out;
        }
        
        /* === å›¾ç‰‡è¿‡æ¸¡åŠ¨ç”» (Image Transition) === */
        .image-transition {
            opacity: 0;
            transform: scale(0.98); /* Start slightly smaller */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .image-transition.loaded {
            opacity: 1;
            transform: scale(1); /* End at full size */
        }
        
        /* === å‡çº§/é€šå…³ åŠ¨ç”»è¦†ç›–å±‚ (Level Up/Completion Animation) === */
        #congratulations-overlay {
            transition: opacity 0.5s ease-out;
            opacity: 0;
        }
        #congratulations-overlay.overlay-visible {
            opacity: 1;
            display: flex; /* Overrides the 'hidden' class visually */
        }
        
        /* Keyframes for the burst effect (Level Up) */
        @keyframes burst {
            0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(0deg); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        /* Keyframes for the completion effect (slower, grander) */
        @keyframes grand-burst {
            0% { opacity: 0; transform: scale(0.3); }
            20% { opacity: 1; transform: scale(1.05); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
    </style>
</head>
<body>

<!-- åŠ è½½/è®¤è¯ è¦†ç›–å±‚ -->
<div id="loading-screen" class="loading-overlay hidden">
    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-4 text-xl text-blue-800">æ­£åœ¨å‡†å¤‡â€œç¯çƒè¯­éŸ³ä¹‹æ—…â€...</p>
</div>

<!-- å¤´éƒ¨ï¼šè¿›åº¦æ¡ä¸åˆ†æ•° -->
<header class="w-full bg-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-50">
    <div class="flex items-center space-x-4">
        <span class="text-3xl text-yellow-500">ğŸš¢</span>
        <div class="flex flex-col">
            <div id="level-display" class="font-bold text-xl text-gray-700">åŠ è½½ä¸­...</div>
            <div class="text-sm text-gray-500">å½“å‰ç›®çš„åœ°</div>
        </div>
    </div>
    <div class="flex items-center space-x-2">
        <span class="text-3xl text-red-500">ğŸ”¥</span>
        <div class="flex flex-col items-end">
            <span id="fuel-display" class="font-bold text-2xl text-red-700">0</span>
            <span class="text-sm text-gray-500">ç‡ƒæ–™/ç§¯åˆ†</span>
        </div>
    </div>
</header>

<!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
<main id="game-container" class="flex-grow w-full max-w-lg p-4 flex flex-col items-center space-y-8 md:space-y-12">
    
    <!-- ä»»åŠ¡å¡ç‰‡ -->
    <div id="task-card" class="card bg-white w-full rounded-2xl p-6 text-center mt-6">
        <!-- ä»»åŠ¡æè¿°æ›´æ–° -->
        <div class="text-gray-500 text-lg mb-4">è¯·æ ¹æ®ä¸­æ–‡æç¤ºï¼Œå¤§å£°è¯»å‡ºæ­£ç¡®çš„è‹±æ–‡ï¼š</div>
        
        <!-- å›¾ç‰‡åŒºåŸŸ (ç°åœ¨æ˜¾ç¤ºè‹±æ–‡ç›®æ ‡è¯) -->
        <div class="w-full h-40 md:h-64 bg-gray-200 rounded-xl mb-6 flex items-center justify-center overflow-hidden">
             <!-- Placeholder Image (Now uses ENGLISH word for visual context) -->
             <img id="item-image" src="https://placehold.co/300x300/5b95ff/ffffff?text=Loading" onerror="this.src='https://placehold.co/300x300/5b95ff/ffffff?text=Loading'" alt="è‹±æ–‡ç›®æ ‡è¯" class="w-full h-full object-cover image-transition">
        </div>

        <!-- ç›®æ ‡å•è¯ (ç°åœ¨æ˜¾ç¤º CHINESE HINT) -->
        <div id="target-word" class="text-5xl md:text-6xl font-extrabold text-gray-800 mb-6 tracking-wide">...</div>
        
        <!-- æ”¶å¬æŒ‰é’® (å¤§å–‡å­) -->
        <button id="listen-btn" onclick="speakTargetWord()" class="btn-xl bg-blue-500 hover:bg-blue-600 text-white w-full flex items-center justify-center space-x-3 transition">
            <i data-lucide="volume-2" class="w-8 h-8 md:w-10 md:h-10"></i>
            <span class="text-3xl">æ”¶å¬æ ‡å‡†å‘éŸ³</span>
        </button>
    </div>

    <!-- éº¦å…‹é£åŒºåŸŸ (åº•éƒ¨ä¸­å¤®ï¼Œæœ€å¤§çš„æ“ä½œåŒº) -->
    <div class="w-full flex flex-col items-center justify-center pb-8 space-y-4">
        <button id="mic-btn" onclick="startListening()" class="flex flex-col items-center justify-center w-36 h-36 md:w-48 md:h-48 rounded-full bg-red-500 hover:bg-red-600 text-white shadow-2xl transition duration-200 ease-in-out">
            <i id="mic-icon" data-lucide="mic" class="w-12 h-12 md:w-16 md:h-16"></i>
            <span id="mic-text" class="mt-2 text-2xl font-bold">ç‚¹æˆ‘è¯´è¯</span>
        </button>

        <!-- æ–°å¢: è·³è¿‡å¹¶ç»§ç»­é”® -->
        <button id="skip-btn" onclick="closeFeedbackModal()" class="flex items-center justify-center space-x-2 text-xl font-medium text-gray-600 hover:text-gray-800 transition duration-150 p-3 rounded-xl bg-gray-200 hover:bg-gray-300 w-2/3 max-w-xs shadow-md">
            <i data-lucide="arrow-right-circle" class="w-6 h-6"></i>
            <span>è·³è¿‡å¹¶ç»§ç»­ (ä¸‹ä¸€é¢˜)</span>
        </button>
    </div>
</main>

<!-- è¯„åˆ†åé¦ˆå¼¹çª— (Modal) -->
<div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div id="modal-content" class="bg-white rounded-3xl p-8 text-center modal-enter w-full max-w-sm">
        <div id="feedback-icon" class="text-7xl mb-4"></div>
        <h2 id="feedback-title" class="text-4xl font-bold mb-2"></h2>
        <p id="feedback-message" class="text-xl text-gray-700 mb-6"></p>
        
        <!-- æ›´æ–°åçš„æŒ‰é’®å®¹å™¨ï¼Œç”¨äºæ˜¾ç¤ºé‡è¯•å’Œç»§ç»­æŒ‰é’® -->
        <div class="flex flex-col space-y-4">
            <button id="retry-btn" onclick="retryTask()" class="btn-xl bg-red-500 hover:bg-red-600 text-white w-full hidden">å†è¯´ä¸€æ¬¡ (é‡è¯•)</button>
            <button id="continue-btn" onclick="closeFeedbackModal()" class="btn-xl bg-blue-500 hover:bg-blue-600 text-white w-full">ç»§ç»­æ—…ç¨‹</button>
        </div>

    </div>
</div>

<!-- æ–°å¢ï¼šå…¨å±æ­å–œåŠ¨ç”»è¦†ç›–å±‚ (Level Up/Completion Animation) -->
<div id="congratulations-overlay" class="fixed inset-0 z-[1001] bg-blue-500/90 hidden flex-col items-center justify-center pointer-events-none p-4">
    <div class="text-white text-center">
        <!-- åŠ¨ç”»å›¾æ ‡ï¼šscale-50 opacity-0 æ˜¯ä¸ºäº†è®©åŠ¨ç”»ä» 0 å¼€å§‹ -->
        <div id="overlay-icon" class="text-8xl mb-4 opacity-0 scale-50"></div>
        <!-- åŠ¨ç”»æ ‡é¢˜ï¼štext-6xl/text-8xl åŠ¨æ€è°ƒæ•´ -->
        <h1 id="overlay-title" class="text-6xl md:text-8xl font-black mb-2 opacity-0 scale-50"></h1>
        <!-- åŠ¨ç”»ä¿¡æ¯ -->
        <p id="overlay-message" class="text-3xl opacity-0 scale-50"></p>
    </div>
</div>


<script type="module">
    // --- 1. FIREBASE SETUP (MANDATORY) ---
    // å·²å°† Google GStatic åŸŸåæ›¿æ¢ä¸º jsDelivr CDNï¼Œä»¥æé«˜å…¨çƒï¼ˆåŒ…æ‹¬ä¸­å›½å¤§é™†ï¼‰çš„è®¿é—®ç¨³å®šæ€§
    import { initializeApp } from "https://cdn.jsdelivr.net/npm/firebase@11.6.1/app/+esm";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://cdn.jsdelivr.net/npm/firebase@11.6.1/auth/+esm";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://cdn.jsdelivr.net/npm/firebase@11.6.1/firestore/+esm";
    import { setLogLevel } from "https://cdn.jsdelivr.net/npm/firebase@11.6.1/firestore/+esm";
    
    // Global Firebase references
    let db;
    let auth;
    let userId;
    let appId;
    
    // State for level detection
    let _lastKnownLevel = 1;

    // Canvas provided global variables
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    appId = typeof __app_id !== 'undefined' ? __app_id : 'global-voice-journey-default-id';

    const progressPath = (uid) => `artifacts/${appId}/users/${uid}/voice_journey_progress/data`;
    
    // --- 2. GAME DATA AND STATE ---

    // æ¸¸æˆå…³å¡æ•°æ®ï¼šè¯æ±‡åº“å·²æ‰©å¤§è‡³ 100 ä¸ªæ¡ç›®ï¼Œåˆ†ä¸º 5 ä¸ªçº§åˆ«ï¼Œæ¯çº§ 20 ä¸ªã€‚
    const GAME_DATA = [
        // Level 1: å®¶å±…åŸºç¡€ ğŸ¡ (Items 0-19, Fuel: 10) - ç›®æ ‡æ™‹çº§ç‡ƒæ–™: 200
        { word: "Apple", hint: "è‹¹æœ", fuel: 10, imageUrl: "https://placehold.co/300x300/e6e6fa/000000?text=Apple" },
        { word: "Book", hint: "ä¹¦", fuel: 10, imageUrl: "https://placehold.co/300x300/add8e6/000000?text=Book" },
        { word: "Chair", hint: "æ¤…å­", fuel: 10, imageUrl: "https://placehold.co/300x300/f08080/000000?text=Chair" },
        { word: "Television", hint: "ç”µè§†", fuel: 10, imageUrl: "https://placehold.co/300x300/e9967a/000000?text=Television" },
        { word: "Table", hint: "æ¡Œå­", fuel: 10, imageUrl: "https://placehold.co/300x300/90ee90/000000?text=Table" },
        { word: "Lamp", hint: "å°ç¯", fuel: 10, imageUrl: "https://placehold.co/300x300/daa520/000000?text=Lamp" },
        { word: "Window", hint: "çª—æˆ·", fuel: 10, imageUrl: "https://placehold.co/300x300/ffb6c1/000000?text=Window" },
        { word: "Door", hint: "é—¨", fuel: 10, imageUrl: "https://placehold.co/300x300/87cefa/000000?text=Door" },
        { word: "Bed", hint: "åºŠ", fuel: 10, imageUrl: "https://placehold.co/300x300/ffa07a/000000?text=Bed" },
        { word: "Sofa", hint: "æ²™å‘", fuel: 10, imageUrl: "https://placehold.co/300x300/20b2aa/000000?text=Sofa" },
        { word: "Kitchen", hint: "å¨æˆ¿", fuel: 10, imageUrl: "https://placehold.co/300x300/008080/ffffff?text=Kitchen" },
        { word: "Bathroom", hint: "æµ´å®¤", fuel: 10, imageUrl: "https://placehold.co/300x300/4682b4/ffffff?text=Bathroom" },
        { word: "Key", hint: "é’¥åŒ™", fuel: 10, imageUrl: "https://placehold.co/300x300/dc143c/ffffff?text=Key" },
        { word: "Floor", hint: "åœ°æ¿", fuel: 10, imageUrl: "https://placehold.co/300x300/ff6347/ffffff?text=Floor" },
        { word: "Ceiling", hint: "å¤©èŠ±æ¿", fuel: 10, imageUrl: "https://placehold.co/300x300/b22222/ffffff?text=Ceiling" },
        { word: "Carpet", hint: "åœ°æ¯¯", fuel: 10, imageUrl: "https://placehold.co/300x300/ffd700/000000?text=Carpet" },
        { word: "Photo frame", hint: "ç›¸æ¡†", fuel: 10, imageUrl: "https://placehold.co/300x300/87ceeb/000000?text=Photo%20frame" },
        { word: "Vase", hint: "èŠ±ç“¶", fuel: 10, imageUrl: "https://placehold.co/300x300/f5deb3/000000?text=Vase" },
        { word: "Curtain", hint: "çª—å¸˜", fuel: 10, imageUrl: "https://placehold.co/300x300/da70d6/000000?text=Curtain" },
        { word: "Balcony", hint: "é˜³å°", fuel: 10, imageUrl: "https://placehold.co/300x300/6b8e23/ffffff?text=Balcony" },
        
        // Level 2: ç¤¾åŒºäº¤æµ ğŸ’¬ (Items 20-39, Fuel: 15) - ç›®æ ‡æ™‹çº§ç‡ƒæ–™: 500
        { word: "My friend", hint: "æˆ‘çš„æœ‹å‹", fuel: 15, imageUrl: "https://placehold.co/300x300/f0e68c/000000?text=My%20friend" },
        { word: "Nice to meet you", hint: "å¾ˆé«˜å…´è®¤è¯†ä½ ", fuel: 15, imageUrl: "https://placehold.co/300x300/48d1cc/000000?text=Nice%20to%20meet%20you" },
        { word: "How old are you", hint: "ä½ å¤šå¤§äº†", fuel: 15, imageUrl: "https://placehold.co/300x300/ff7f50/000000?text=How%20old%20are%20you" },
        { word: "I love you", hint: "æˆ‘çˆ±ä½ ", fuel: 15, imageUrl: "https://placehold.co/300x300/ff69b4/ffffff?text=I%20love%20you" },
        { word: "Good morning", hint: "æ—©ä¸Šå¥½", fuel: 15, imageUrl: "https://placehold.co/300x300/f4a460/000000?text=Good%20morning" },
        { word: "Good night", hint: "æ™šå®‰", fuel: 15, imageUrl: "https://placehold.co/300x300/1e90ff/ffffff?text=Good%20night" },
        { word: "See you later", hint: "å›å¤´è§", fuel: 15, imageUrl: "https://placehold.co/300x300/228b22/ffffff?text=See%20you%20later" },
        { word: "Excuse me", hint: "ä¸å¥½æ„æ€", fuel: 15, imageUrl: "https://placehold.co/300x300/6a5acd/ffffff?text=Excuse%20me" },
        { word: "Thank you", hint: "è°¢è°¢ä½ ", fuel: 15, imageUrl: "https://placehold.co/300x300/cd5c5c/ffffff?text=Thank%20you" },
        { word: "You are welcome", hint: "ä¸å®¢æ°”", fuel: 15, imageUrl: "https://placehold.co/300x300/98fb98/000000?text=You%20are%20welcome" },
        { word: "How are you", hint: "ä½ å¥½å—", fuel: 15, imageUrl: "https://placehold.co/300x300/ffa07a/000000?text=How%20are%20you" },
        { word: "I'm fine", hint: "æˆ‘å¾ˆå¥½", fuel: 15, imageUrl: "https://placehold.co/300x300/20b2aa/000000?text=I'm%20fine" },
        { word: "What's your name", hint: "ä½ å«ä»€ä¹ˆåå­—", fuel: 15, imageUrl: "https://placehold.co/300x300/008080/ffffff?text=What's%20your%20name" },
        { word: "My name is", hint: "æˆ‘çš„åå­—æ˜¯", fuel: 15, imageUrl: "https://placehold.co/300x300/4682b4/ffffff?text=My%20name%20is" },
        { word: "Where are you from", hint: "ä½ æ¥è‡ªå“ªé‡Œ", fuel: 15, imageUrl: "https://placehold.co/300x300/dc143c/ffffff?text=Where%20are%20you%20from" },
        { word: "I am from China", hint: "æˆ‘æ¥è‡ªä¸­å›½", fuel: 15, imageUrl: "https://placehold.co/300x300/ff6347/ffffff?text=I%20am%20from%20China" },
        { word: "What do you do", hint: "ä½ æ˜¯åšä»€ä¹ˆçš„", fuel: 15, imageUrl: "https://placehold.co/300x300/b22222/ffffff?text=What%20do%20you%20do" },
        { word: "I am retired", hint: "æˆ‘é€€ä¼‘äº†", fuel: 15, imageUrl: "https://placehold.co/300x300/ffd700/000000?text=I%20am%20retired" },
        { word: "Do you speak English", hint: "ä½ ä¼šè¯´è‹±è¯­å—", fuel: 15, imageUrl: "https://placehold.co/300x300/87ceeb/000000?text=Do%20you%20speak%20English" },
        { word: "A little bit", hint: "ä¸€ç‚¹ç‚¹", fuel: 15, imageUrl: "https://placehold.co/300x300/f5deb3/000000?text=A%20little%20bit" },

        // Level 3: æˆ·å¤–æ´»åŠ¨ ğŸï¸ (Items 40-59, Fuel: 20) - ç›®æ ‡æ™‹çº§ç‡ƒæ–™: 900
        { word: "Play chess", hint: "ä¸‹æ£‹", fuel: 20, imageUrl: "https://placehold.co/300x300/00ced1/000000?text=Play%20chess" },
        { word: "Sing a song", hint: "å”±æ­Œ", fuel: 20, imageUrl: "https://placehold.co/300x300/ff6347/ffffff?text=Sing%20a%20song" },
        { word: "Watch a movie", hint: "çœ‹ç”µå½±", fuel: 20, imageUrl: "https://placehold.co/300x300/6495ed/ffffff?text=Watch%20a%20movie" },
        { word: "Go hiking", hint: "å»å¾’æ­¥", fuel: 20, imageUrl: "https://placehold.co/300x300/20b2aa/ffffff?text=Go%20hiking" },
        { word: "Listen to music", hint: "å¬éŸ³ä¹", fuel: 20, imageUrl: "https://placehold.co/300x300/ffa500/000000?text=Listen%20to%20music" },
        { word: "Draw a picture", hint: "ç”»ç”»", fuel: 20, imageUrl: "https://placehold.co/300x300/d8bfd8/000000?text=Draw%20a%20picture" },
        { word: "I like swimming", hint: "æˆ‘å–œæ¬¢æ¸¸æ³³", fuel: 20, imageUrl: "https://placehold.co/300x300/40e0d0/000000?text=I%20like%20swimming" },
        { word: "Read newspaper", hint: "çœ‹æŠ¥çº¸", fuel: 20, imageUrl: "https://placehold.co/300x300/f0f8ff/000000?text=Read%20newspaper" },
        { word: "Play cards", hint: "ç©ç‰Œ", fuel: 20, imageUrl: "https://placehold.co/300x300/9acd32/000000?text=Play%20cards" },
        { word: "Go fishing", hint: "å»é’“é±¼", fuel: 20, imageUrl: "https://placehold.co/300x300/008080/ffffff?text=Go%20fishing" },
        { word: "Take photos", hint: "æ‹ç…§", fuel: 20, imageUrl: "https://placehold.co/300x300/ffdead/000000?text=Take%20photos" },
        { word: "Do yoga", hint: "åšç‘œä¼½", fuel: 20, imageUrl: "https://placehold.co/300x300/ba55d3/ffffff?text=Do%20yoga" },
        { word: "Cook dinner", hint: "åšæ™šé¥­", fuel: 20, imageUrl: "https://placehold.co/300x300/f5deb3/000000?text=Cook%20dinner" },
        { word: "Dancing lesson", hint: "èˆè¹ˆè¯¾", fuel: 20, imageUrl: "https://placehold.co/300x300/ff1493/ffffff?text=Dancing%20lesson" },
        { word: "Park walk", hint: "å…¬å›­æ•£æ­¥", fuel: 20, imageUrl: "https://placehold.co/300x300/8fbc8f/000000?text=Park%20walk" },
        { word: "Visit museum", hint: "å‚è§‚åšç‰©é¦†", fuel: 20, imageUrl: "https://placehold.co/300x300/7b68ee/ffffff?text=Visit%20museum" },
        { word: "Weekend trip", hint: "å‘¨æœ«æ—…è¡Œ", fuel: 20, imageUrl: "https://placehold.co/300x300/ff7f50/000000?text=Weekend%20trip" },
        { word: "Nature reserve", hint: "è‡ªç„¶ä¿æŠ¤åŒº", fuel: 20, imageUrl: "https://placehold.co/300x300/3cb371/ffffff?text=Nature%20reserve" },
        { word: "Mountain climbing", hint: "çˆ¬å±±", fuel: 20, imageUrl: "https://placehold.co/300x300/a0522d/ffffff?text=Mountain%20climbing" },
        { word: "Gardening time", hint: "å›­è‰ºæ—¶é—´", fuel: 20, imageUrl: "https://placehold.co/300x300/cd853f/000000?text=Gardening%20time" },

        // Level 4: äº¤é€šå‡ºè¡Œ ğŸš— (Items 60-79, Fuel: 25) - ç›®æ ‡æ™‹çº§ç‡ƒæ–™: 1400
        { word: "Bus stop", hint: "å…¬äº¤è½¦ç«™", fuel: 25, imageUrl: "https://placehold.co/300x300/ffa07a/000000?text=Bus%20stop" },
        { word: "Turn left", hint: "å·¦è½¬", fuel: 25, imageUrl: "https://placehold.co/300x300/20b2aa/000000?text=Turn%20left" },
        { word: "Straight ahead", hint: "ç›´èµ°", fuel: 25, imageUrl: "https://placehold.co/300x300/008080/ffffff?text=Straight%20ahead" },
        { word: "Where is the airport", hint: "æœºåœºåœ¨å“ªé‡Œ", fuel: 25, imageUrl: "https://placehold.co/300x300/87ceeb/000000?text=Where%20is%20the%20airport" },
        { word: "Subway station", hint: "åœ°é“ç«™", fuel: 25, imageUrl: "https://placehold.co/300x300/4682b4/ffffff?text=Subway%20station" },
        { word: "Ticket office", hint: "å”®ç¥¨å¤„", fuel: 25, imageUrl: "https://placehold.co/300x300/dc143c/ffffff?text=Ticket%20office" },
        { word: "Is this the right way", hint: "è¿™æ¡è·¯å¯¹å—", fuel: 25, imageUrl: "https://placehold.co/300x300/ff6347/ffffff?text=Is%20this%20the%20right%20way" },
        { word: "I need a taxi", hint: "æˆ‘éœ€è¦ä¸€è¾†å‡ºç§Ÿè½¦", fuel: 25, imageUrl: "https://placehold.co/300x300/b22222/ffffff?text=I%20need%20a%20taxi" },
        { word: "Turn right", hint: "å³è½¬", fuel: 25, imageUrl: "https://placehold.co/300x300/ffd700/000000?text=Turn%20right" },
        { word: "Traffic light", hint: "äº¤é€šç¯", fuel: 25, imageUrl: "https://placehold.co/300x300/87ceeb/000000?text=Traffic%20light" },
        { word: "Drive slowly", hint: "æ…¢ç‚¹å¼€è½¦", fuel: 25, imageUrl: "https://placehold.co/300x300/f5deb3/000000?text=Drive%20slowly" },
        { word: "Parking lot", hint: "åœè½¦åœº", fuel: 25, imageUrl: "https://placehold.co/300x300/da70d6/000000?text=Parking%20lot" },
        { word: "Gas station", hint: "åŠ æ²¹ç«™", fuel: 25, imageUrl: "https://placehold.co/300x300/6b8e23/ffffff?text=Gas%20station" },
        { word: "High-speed rail", hint: "é«˜é“", fuel: 25, imageUrl: "https://placehold.co/300x300/00ced1/000000?text=High-speed%20rail" },
        { word: "Cross the road", hint: "è¿‡é©¬è·¯", fuel: 25, imageUrl: "https://placehold.co/300x300/d8bfd8/000000?text=Cross%20the%20road" },
        { word: "Which platform", hint: "å“ªä¸ªç«™å°", fuel: 25, imageUrl: "https://placehold.co/300x300/40e0d0/000000?text=Which%20platform" },
        { word: "Train departure", hint: "ç«è½¦å‡ºå‘", fuel: 25, imageUrl: "https://placehold.co/300x300/ffb6c1/000000?text=Train%20departure" },
        { word: "Flight number", hint: "èˆªç­å·", fuel: 25, imageUrl: "https://placehold.co/300x300/87cefa/000000?text=Flight%20number" },
        { word: "Boarding gate", hint: "ç™»æœºå£", fuel: 25, imageUrl: "https://placehold.co/300x300/ffa07a/000000?text=Boarding%20gate" },
        { word: "Seat belt", hint: "å®‰å…¨å¸¦", fuel: 25, imageUrl: "https://placehold.co/300x300/f08080/000000?text=Seat%20belt" },

        // Level 5: ç´§æ€¥æ±‚åŠ© ğŸ†˜ (Items 80-99, Fuel: 30) - ç›®æ ‡æ™‹çº§ç‡ƒæ–™: 2000
        { word: "I need help", hint: "æˆ‘éœ€è¦å¸®åŠ©", fuel: 30, imageUrl: "https://placehold.co/300x300/dc143c/ffffff?text=I%20need%20help" },
        { word: "Call a doctor", hint: "å«åŒ»ç”Ÿ", fuel: 30, imageUrl: "https://placehold.co/300x300/ff6347/ffffff?text=Call%20a%20doctor" },
        { word: "Where is the police", hint: "è­¦å¯Ÿåœ¨å“ªé‡Œ", fuel: 30, imageUrl: "https://placehold.co/300x300/ffd700/000000?text=Where%20is%20the%20police" },
        { word: "Stop!", hint: "åœæ­¢ï¼", fuel: 30, imageUrl: "https://placehold.co/300x300/b22222/ffffff?text=Stop!" },
        { word: "I lost my passport", hint: "æˆ‘ä¸¢äº†æŠ¤ç…§", fuel: 30, imageUrl: "https://placehold.co/300x300/4682b4/ffffff?text=I%20lost%20my%20passport" },
        { word: "Emergency exit", hint: "ç´§æ€¥å‡ºå£", fuel: 30, imageUrl: "https://placehold.co/300x300/1e90ff/ffffff?text=Emergency%20exit" },
        { word: "I feel sick", hint: "æˆ‘æ„Ÿè§‰ä¸èˆ’æœ", fuel: 30, imageUrl: "https://placehold.co/300x300/ff69b4/ffffff?text=I%20feel%20sick" },
        { word: "Where is the hospital", hint: "åŒ»é™¢åœ¨å“ªé‡Œ", fuel: 30, imageUrl: "https://placehold.co/300x300/da70d6/ffffff?text=Where%20is%20the%20hospital" },
        { word: "I have a fever", hint: "æˆ‘å‘çƒ§äº†", fuel: 30, imageUrl: "https://placehold.co/300x300/cd5c5c/ffffff?text=I%20have%20a%20fever" },
        { word: "Take medicine", hint: "åƒè¯", fuel: 30, imageUrl: "https://placehold.co/300x300/87ceeb/000000?text=Take%20medicine" },
        { word: "Fire!", hint: "ç€ç«äº†ï¼", fuel: 30, imageUrl: "https://placehold.co/300x300/8b0000/ffffff?text=Fire!" },
        { word: "Call 911", hint: "æ‰“911", fuel: 30, imageUrl: "https://placehold.co/300x300/f08080/000000?text=Call%20911" },
        { word: "Lost my wallet", hint: "æˆ‘çš„é’±åŒ…ä¸¢äº†", fuel: 30, imageUrl: "https://placehold.co/300x300/f0e68c/000000?text=Lost%20my%20wallet" },
        { word: "Where is the consulate", hint: "é¢†äº‹é¦†åœ¨å“ªé‡Œ", fuel: 30, imageUrl: "https://placehold.co/300x300/9acd32/000000?text=Where%20is%20the%20consulate" },
        { word: "I need an ambulance", hint: "æˆ‘éœ€è¦æ•‘æŠ¤è½¦", fuel: 30, imageUrl: "https://placehold.co/300x300/7fffd4/000000?text=I%20need%20an%20ambulance" },
        { word: "Can you translate", hint: "ä½ èƒ½ç¿»è¯‘ä¸€ä¸‹å—", fuel: 30, imageUrl: "https://placehold.co/300x300/d8bfd8/000000?text=Can%20you%20translate" },
        { word: "Danger!", hint: "å±é™©ï¼", fuel: 30, imageUrl: "https://placehold.co/300x300/ff4500/ffffff?text=Danger!" },
        { word: "Stay calm", hint: "ä¿æŒå†·é™", fuel: 30, imageUrl: "https://placehold.co/300x300/afeeee/000000?text=Stay%20calm" },
        { word: "Please wait here", hint: "è¯·åœ¨è¿™é‡Œç­‰", fuel: 30, imageUrl: "https://placehold.co/300x300/696969/ffffff?text=Please%20wait%20here" },
        { word: "Give me water", hint: "ç»™æˆ‘æ°´", fuel: 30, imageUrl: "https://placehold.co/300x300/b0e0e6/000000?text=Give%20me%20water" },
    ];
    
    let currentLevelIndex = 0; // ä»»åŠ¡è®¡æ•°å™¨
    let userFuel = 0;
    
    // 5ä¸ªçº§åˆ« + 1ä¸ªæœ€ç»ˆå®Œæˆçº§åˆ« (Level 6)
    const LEVEL_NAMES = [
        "å®¶å±…åŸºç¡€ ğŸ¡", "ç¤¾åŒºäº¤æµ ğŸ’¬", "æˆ·å¤–æ´»åŠ¨ ğŸï¸", "äº¤é€šå‡ºè¡Œ ğŸš—", "ç´§æ€¥æ±‚åŠ© ğŸ†˜", "ç¯çƒè¾¾äºº ğŸŒ" // Level 6 æ˜¯é€šå…³æ ‡å¿—
    ];

    // å‡çº§æ‰€éœ€çš„ç‡ƒæ–™
    const LEVEL_UP_REQUIREMENTS = [0, 20, 50, 90, 140, 210];

    // --- 3. SPEECH APIs SETUP ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechSynthesis = window.speechSynthesis;
    const recognitionAvailable = !!SpeechRecognition;
    const synthAvailable = !!SpeechSynthesis;
    let recognition;

    if (recognitionAvailable) {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; // ç›®æ ‡è¯†åˆ«è¯­è¨€ï¼šç¾å¼è‹±æ–‡ (en-US)
        recognition.interimResults = false; 
        recognition.maxAlternatives = 1; 
    }

    // --- 4. GAME FUNCTIONS ---
    
    // æ–°å¢å‡½æ•°: æ’’èŠ±æ•ˆæœ (Confetti Effect)
    function launchConfetti() {
        // æ£€æŸ¥å…¨å±€çš„ confetti å‡½æ•°æ˜¯å¦å¯ç”¨ (ç”± CDN å¼•å…¥)
        if (typeof confetti === 'function') {
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            // zIndex 1002 ç¡®ä¿åœ¨ congratulations-overlay (1001) ä¹‹ä¸Š
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1002 }; 

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                
                // ä»å·¦ä¸Šè§’å‘å°„
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                }));
                // ä»å³ä¸Šè§’å‘å°„
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                }));
            }, 250);
        }
    }

    
    // 4.1. è·å–å½“å‰æ¸¸æˆç­‰çº§ (æ ¹æ®ç‡ƒæ–™è‡ªåŠ¨ç¡®å®š)
    function getCurrentGameLevel(fuelToCheck = userFuel) {
        let level = 1;
        for (let i = 1; i < LEVEL_UP_REQUIREMENTS.length; i++) {
            if (fuelToCheck >= LEVEL_UP_REQUIREMENTS[i]) {
                level = i + 1;
            } else {
                break;
            }
        }
        // Level can go up to LEVEL_NAMES.length (which is 6, the completion level)
        return Math.min(level, LEVEL_NAMES.length); 
    }

    // 4.2. åŠ è½½å’Œæ¸²æŸ“å½“å‰ä»»åŠ¡ (ä»å½“å‰ç­‰çº§çš„è¯æ±‡åº“ä¸­éšæœºæŠ½å–)
    function loadCurrentTask() {
        const currentLevel = getCurrentGameLevel();
        const levelIndex = currentLevel - 1;

        // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰å…³å¡
        if (currentLevel >= LEVEL_NAMES.length) { 
            showCompletionScreen();
            return;
        }

        // Level index 0 corresponds to L1, index 4 corresponds to L5.
        // Determine the index range for the current level (20 items per level)
        const startIndex = levelIndex * 20; // L1: 0, L2: 20, L5: 80
        const itemsInLevel = 20;
        
        // Randomly select an index within the current level's range
        const randomIndex = Math.floor(Math.random() * itemsInLevel) + startIndex;
        const data = GAME_DATA[randomIndex];
        
        // æ›´æ–° UI æ˜¾ç¤ºå½“å‰çº§åˆ«åç§°å’Œæ•°å­—
        document.getElementById('level-display').textContent = `${LEVEL_NAMES[levelIndex]} (Level ${currentLevel})`;
        
        const itemImage = document.getElementById('item-image');
        
        // ç›®æ ‡å•è¯ç°åœ¨åªæ˜¾ç¤º CHINESE HINT (è¿™æ˜¯ç”¨æˆ·éœ€è¦è¯»å‡ºè‹±æ–‡çš„æç¤º)
        document.getElementById('target-word').textContent = data.hint; 
        
        // å›¾ç‰‡åŒºåŸŸç°åœ¨æ˜¾ç¤ºè‹±æ–‡å•è¯ (é€šè¿‡ placehold.co æœåŠ¡å°†è‹±æ–‡å•è¯æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸­)
        itemImage.classList.remove('loaded');
        
        itemImage.onload = () => {
            itemImage.classList.add('loaded');
        };

        let textForImage = data.word;
        textForImage = encodeURIComponent(textForImage).replace(/%20/g, '+');
        textForImage = textForImage.replace(/!/g, '%21').replace(/,/g, '%2C'); 
        
        const newImageUrl = `https://placehold.co/300x300/5b95ff/ffffff?text=${textForImage}`;
        itemImage.src = newImageUrl;
        
        if (itemImage.complete && itemImage.naturalWidth > 0) {
            itemImage.onload(null);
        }

        // ç¡®ä¿éº¦å…‹é£æŒ‰é’®çŠ¶æ€æ­£ç¡®
        document.getElementById('mic-btn').classList.remove('listening');
        document.getElementById('mic-text').textContent = "ç‚¹æˆ‘è¯´è¯";
        document.getElementById('mic-btn').disabled = false;
        
        // ç¡®ä¿æŒ‰é’®æ˜¯å¯ç”¨çš„
        document.getElementById('listen-btn').disabled = false;
        document.getElementById('skip-btn').disabled = false; // å¯ç”¨è·³è¿‡æŒ‰é’®
    }
    
    // 4.3. æ–‡æœ¬è½¬è¯­éŸ³ (æ”¶å¬æŒ‰é’®)
    window.speakTargetWord = function() {
        if (!synthAvailable) {
            console.error("Text-to-Speech not supported.");
            showFeedback('âŒ', 'æŠ±æ­‰', 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½ã€‚', 'warning', 3); 
            return;
        }

        // æŸ¥æ‰¾å½“å‰æ˜¾ç¤ºçš„ä¸­æ–‡æç¤ºå¯¹åº”çš„è‹±æ–‡å•è¯
        const currentHint = document.getElementById('target-word').textContent;
        const data = GAME_DATA.find(item => item.hint === currentHint);

        if (!data) {
             console.error("Could not find current word data for TTS.");
             showFeedback('âŒ', 'æŠ±æ­‰', 'æ— æ³•æ‰¾åˆ°å½“å‰ä»»åŠ¡çš„æ ‡å‡†å‘éŸ³ã€‚', 'warning', 3);
             return;
        }

        const targetText = data.word; 
        const utterance = new SpeechSynthesisUtterance(targetText);
        utterance.lang = 'en-US'; 
        
        // è°ƒæ•´è¯­é€Ÿå’ŒéŸ³è°ƒï¼Œæ›´æ¸…æ™°ï¼Œé€‚åˆè€å¹´äººå­¦ä¹ 
        utterance.rate = 0.75; // ç¨æ…¢ä¸€ç‚¹
        utterance.pitch = 1.0; 

        SpeechSynthesis.speak(utterance);
    }
    
    // 4.4. è¯­éŸ³è¯†åˆ« (éº¦å…‹é£æŒ‰é’®)
    window.startListening = function() {
        if (!recognitionAvailable) {
            showFeedback('âš ï¸', 'æŠ±æ­‰', 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨ Chrome æµè§ˆå™¨ã€‚', 'warning', 3); 
            return;
        }
        
        // æŸ¥æ‰¾å½“å‰ç›®æ ‡å•è¯ (é¿å…åœ¨ onresult ä¸­æŸ¥æ‰¾)
        const currentHint = document.getElementById('target-word').textContent;
        const data = GAME_DATA.find(item => item.hint === currentHint);
        if (!data) {
            console.error("Cannot start listening: Target word data missing.");
            showFeedback('âŒ', 'é”™è¯¯', 'æ— æ³•ç¡®å®šå½“å‰ä»»åŠ¡çš„ç›®æ ‡è¯æ±‡ã€‚', 'danger', 1);
            return;
        }

        document.getElementById('mic-btn').classList.add('listening');
        document.getElementById('mic-text').textContent = "æ­£åœ¨å¬æ‚¨è¯´è¯...";
        document.getElementById('mic-btn').disabled = true;

        recognition.onresult = (event) => {
            const spokenText = event.results[0][0].transcript;
            // è¯„åˆ†
            evaluateResult(spokenText, data.word, data.fuel); 
        };

        recognition.onerror = (event) => {
            console.error("Speech Recognition Error:", event.error);
            document.getElementById('mic-btn').classList.remove('listening');
            document.getElementById('mic-text').textContent = "ç‚¹æˆ‘è¯´è¯";
            document.getElementById('mic-btn').disabled = false;
            showFeedback('ğŸ˜”', 'è¯†åˆ«å¤±è´¥', 'è¯·ç¡®ä¿éº¦å…‹é£å¯ç”¨ï¼Œå¹¶è¯·å†æ¬¡å°è¯•æ¸…æ™°åœ°å‘éŸ³ã€‚', 'danger', 1);
        };

        recognition.onend = () => {
             document.getElementById('mic-btn').classList.remove('listening');
             document.getElementById('mic-text').textContent = "ç‚¹æˆ‘è¯´è¯";
             document.getElementById('mic-btn').disabled = false;
        };

        try {
             recognition.start();
        } catch (e) {
            console.error("Recognition start failed:", e);
            document.getElementById('mic-btn').classList.remove('listening');
            document.getElementById('mic-text').textContent = "ç‚¹æˆ‘è¯´è¯";
            document.getElementById('mic-btn').disabled = false;
            showFeedback('âš ï¸', 'éº¦å…‹é£é”™è¯¯', 'è¯·æ£€æŸ¥æµè§ˆå™¨éº¦å…‹é£æƒé™è®¾ç½®ã€‚', 'danger', 1);
        }
    }

    // 4.5. è¯„åˆ†é€»è¾‘
    let lastScoreGain = 0; // è·Ÿè¸ªæœ¬æ¬¡è·å¾—çš„ç‡ƒæ–™
    function evaluateResult(spokenText, targetWord, baseFuel) {
        
        const spokenLower = spokenText.toLowerCase().trim();
        const targetLower = targetWord.toLowerCase().trim();

        let score = 0;
        let title = '';
        let message = '';
        let icon = '';
        let newFuel = 0;

        // è¯„åˆ†é€»è¾‘ï¼šä½¿ç”¨å½“å‰å…³å¡çš„ baseFuel æ¥è®¡ç®—å¾—åˆ†
        const perfectMatch = spokenLower === targetLower;
        const closeMatch = spokenLower.includes(targetLower) || targetLower.includes(spokenLower);
        const acceptableThreshold = spokenLower.length > 0 && (spokenLower.includes(targetLower.slice(0, Math.floor(targetLower.length * 0.7))));

        if (perfectMatch || (closeMatch && spokenLower.length >= targetLower.length * 0.8)) {
            score = 3;
            newFuel = baseFuel; // å®Œç¾åŒ¹é…ï¼Œè·å¾—å®Œæ•´ç‡ƒæ–™ (L1: 10, L2: 15, ...)
            title = 'å®Œç¾ï¼ğŸ‘';
            message = `æ‚¨è¯´çš„æ˜¯ "${spokenText}"ï¼Œå‘éŸ³éå¸¸æ¸…æ™°ï¼å¥–åŠ± ${newFuel} ç‡ƒæ–™ï¼`;
            icon = 'ğŸ¥³';
        } else if (acceptableThreshold) {
            score = 2;
            newFuel = Math.floor(baseFuel / 2); // å°šå¯ï¼Œè·å¾—ä¸€åŠç‡ƒæ–™
            title = 'å°šå¯ï¼ğŸ‘';
            message = `æ‚¨è¯´çš„æ˜¯ "${spokenText}"ã€‚å‘éŸ³å¬å¾—æ‡‚ï¼Œå†ç»ƒä¹ ä¸€æ¬¡ä¼šæ›´å¥½ï¼å¥–åŠ± ${newFuel} ç‡ƒæ–™ã€‚`;
            icon = 'ğŸ˜Š';
        } else {
            score = 1;
            newFuel = 1; // é¼“åŠ±åˆ†
            title = 'è¯·å†è¯•ä¸€æ¬¡ ğŸ‘‚';
            message = `æ‚¨è¯´çš„æ˜¯ "${spokenText}"ã€‚å†å¬ä¸€æ¬¡æ ‡å‡†å‘éŸ³ï¼Œç„¶åå¤§èƒ†è¯´å‡ºæ¥ï¼å¥–åŠ± ${newFuel} ç‡ƒæ–™ã€‚`;
            icon = 'ğŸ§';
        }

        lastScoreGain = newFuel;
        userFuel += newFuel;
        saveProgress(userFuel); // ç‡ƒæ–™æ›´æ–°ä¼šè§¦å‘ onSnapshotï¼Œç„¶ååœ¨ onSnapshot ä¸­è¿›è¡Œ level check
        
        // ä¼ é€’ score ç»™ showFeedback ä»¥æ§åˆ¶é‡è¯•æŒ‰é’®
        showFeedback(icon, title, message, score > 1 ? 'success' : 'warning', score); 
    }

    // 4.6. æ£€æŸ¥å‡çº§
    function checkLevelUp(newFuel) {
        const previousLevel = _lastKnownLevel;
        const currentLevel = getCurrentGameLevel(newFuel);
        
        if (currentLevel > previousLevel) {
            // ç«‹å³æ›´æ–°å·²çŸ¥ç­‰çº§ï¼Œé˜²æ­¢å¤šæ¬¡è§¦å‘
            _lastKnownLevel = currentLevel; 

            if (currentLevel >= LEVEL_NAMES.length) {
                // Level up to Level 6 (Completion) - è§¦å‘é€šå…³åŠ¨ç”»
                setTimeout(showCompletionScreen, 500);
            } else {
                // Normal Level Up - è§¦å‘å‡çº§åŠ¨ç”»
                launchConfetti(); // ** å‡çº§æ—¶è§¦å‘æ’’èŠ±æ•ˆæœ **
                const nextLevelName = LEVEL_NAMES[currentLevel - 1]; 
                showAnimatedOverlay('ğŸš€', 'æ­å–œå‡çº§ï¼', `æ‚¨å·²è§£é”æ–°ç›®çš„åœ°ï¼š${nextLevelName}ï¼`); 
            }
        }
    }
    
    // 4.7. æ˜¾ç¤ºæœ€ç»ˆé€šå…³ç•Œé¢ (ç°åœ¨è§¦å‘åŠ¨ç”»å’Œé€šå…³ Modal)
    function showCompletionScreen() {
        // ç¡®ä¿æ¸¸æˆæ“ä½œè¢«ç¦ç”¨
        document.getElementById('mic-btn').disabled = true;
        document.getElementById('listen-btn').disabled = true;
        document.getElementById('skip-btn').disabled = true; // ç¦ç”¨è·³è¿‡æŒ‰é’®
        
        // 1. æ˜¾ç¤ºå¤§å¤§çš„é€šå…³åŠ¨ç”»
        showAnimatedOverlay('ğŸ†ğŸŒ', 'ğŸ‰ ç¯çƒè¾¾äººï¼ğŸ‰', 'æ­å–œæ‚¨ï¼æ‰€æœ‰å‘éŸ³ä»»åŠ¡åœ†æ»¡å®Œæˆï¼', true);

        // 2. ç¨åæ˜¾ç¤ºå¸¦æœ‰é‡ç½®æŒ‰é’®çš„ Modal
        setTimeout(() => {
            showFeedback('ğŸ†', 'ç¯çƒæ—…ç¨‹åœ†æ»¡å®Œæˆï¼', 'æ‚¨å·²ç»æŒæ¡äº†æ‰€æœ‰æ ¸å¿ƒå‘éŸ³ä»»åŠ¡ï¼Œå¯ä»¥é‡æ–°å¼€å§‹æŒ‘æˆ˜æ›´å®Œç¾çš„æˆç»©ï¼', 'success', 3, true); 
        }, 500); 
    }

    // 4.8. é‡è¯•å½“å‰ä»»åŠ¡ (ä¸è·³åˆ°ä¸‹ä¸€é¢˜)
    window.retryTask = function() {
        document.getElementById('feedback-modal').classList.add('hidden');
    }

    // 4.9. ç»§ç»­æ—…ç¨‹ï¼ˆæˆåŠŸå®Œæˆæˆ–é€‰æ‹©è·³è¿‡ï¼‰
    window.closeFeedbackModal = function() {
        document.getElementById('feedback-modal').classList.add('hidden');
        
        // å¦‚æœæ˜¯é€šå…³ç•Œé¢ï¼Œå…³é—­åä¸åŠ è½½æ–°ä»»åŠ¡
        if (getCurrentGameLevel() >= LEVEL_NAMES.length) {
             return;
        }

        currentLevelIndex++;
        loadCurrentTask();
    }


    // --- 5. UI/FEEDBACK UTILITIES ---
    
    // 5.0. æ­å–œåŠ¨ç”»å…¨å±è¦†ç›–å±‚
    function showAnimatedOverlay(icon, title, message, isCompletion = false) {
        const overlay = document.getElementById('congratulations-overlay');
        const overlayIcon = document.getElementById('overlay-icon');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayMessage = document.getElementById('overlay-message');

        overlayIcon.textContent = icon;
        overlayTitle.textContent = title;
        overlayMessage.textContent = message;

        // Reset classes
        overlay.classList.remove('bg-blue-500/90', 'bg-green-600/95', 'hidden');

        // Set styles based on type
        if (isCompletion) {
            overlay.classList.add('bg-green-600/95');
            overlayIcon.style.animation = 'grand-burst 10.0s ease-out forwards';
            overlayTitle.style.animation = 'grand-burst 10.0s ease-out 0.2s forwards';
            overlayMessage.style.animation = 'grand-burst 10.0s ease-out 0.4s forwards';
            overlayTitle.classList.add('text-8xl');
            overlayTitle.classList.remove('text-6xl');
        } else {
            overlay.classList.add('bg-blue-500/90');
            // æ³¨æ„ï¼šå‡çº§æ—¶çš„åŠ¨ç”»æ—¶é—´å¯ä»¥è®¾ç½®å¾—æ¯”é€šå…³çŸ­ä¸€äº›
            overlayIcon.style.animation = 'burst 3.0s ease-out forwards'; 
            overlayTitle.style.animation = 'burst 3.0s ease-out 0.2s forwards';
            overlayMessage.style.animation = 'burst 3.0s ease-out 0.4s forwards';
            overlayTitle.classList.add('text-6xl');
            overlayTitle.classList.remove('text-8xl');
        }

        // Show overlay by adding 'overlay-visible'
        overlay.classList.add('overlay-visible');

        // Hide overlay after animation time
        const duration = isCompletion ? 10000 : 3000; // å‡çº§åŠ¨ç”»æŒç»­ 3ç§’
        setTimeout(() => {
            overlay.classList.remove('overlay-visible');
            overlay.classList.add('hidden'); 
            // Clear animation styles to reset for next use
            overlayIcon.style.animation = ''; 
            overlayTitle.style.animation = '';
            overlayMessage.style.animation = '';
        }, duration);
    }

    function showFeedback(icon, title, message, type, score, isCompletion = false) { 
        const modal = document.getElementById('feedback-modal');
        const modalContent = document.getElementById('modal-content');
        const retryBtn = document.getElementById('retry-btn');
        const continueBtn = document.getElementById('continue-btn');
        
        // è®¾ç½®å†…å®¹
        document.getElementById('feedback-icon').textContent = icon;
        document.getElementById('feedback-title').textContent = title;
        document.getElementById('feedback-message').textContent = message;

        // æ ¹æ®åˆ†æ•°å’Œç±»å‹è®¾ç½®æŒ‰é’®çŠ¶æ€
        if (isCompletion) {
            // é€šå…³ç•Œé¢ï¼šåªæ˜¾ç¤ºé‡ç½®æŒ‰é’®
            retryBtn.classList.add('hidden');
            continueBtn.textContent = 'é‡æ–°å¼€å§‹æ¸¸æˆ';
            continueBtn.onclick = resetGame; // ç»‘å®šé‡ç½®å‡½æ•°
            document.getElementById('mic-btn').disabled = true; // ç¦ç”¨æ¸¸æˆæŒ‰é’®
            document.getElementById('listen-btn').disabled = true;
            document.getElementById('skip-btn').disabled = true; // ç¦ç”¨è·³è¿‡æŒ‰é’®
        } else if (score === 1) {
            // ä½åˆ†æ—¶æ˜¾ç¤ºé‡è¯•æŒ‰é’®
            retryBtn.classList.remove('hidden');
            continueBtn.textContent = 'è·³è¿‡ï¼Œå‰å¾€ä¸‹ä¸€ç«™';
            continueBtn.onclick = closeFeedbackModal;
        } else {
            // é«˜åˆ†æ—¶åªæ˜¾ç¤ºç»§ç»­æŒ‰é’®
            retryBtn.classList.add('hidden');
            continueBtn.textContent = 'ç»§ç»­æ—…ç¨‹';
            continueBtn.onclick = closeFeedbackModal;
        }

        // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
        const bgColor = {
            'success': 'bg-green-100 border-green-500',
            'warning': 'bg-yellow-100 border-yellow-500',
            'danger': 'bg-red-100 border-red-500',
        }[type] || 'bg-white border-gray-300';

        modalContent.className = `bg-white rounded-3xl p-8 text-center w-full max-w-sm border-4 ${bgColor}`;

        // æ˜¾ç¤ºåŠ¨ç”»
        modalContent.classList.remove('modal-enter-active');
        modalContent.classList.add('modal-enter');
        modal.classList.remove('hidden');

        setTimeout(() => {
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-enter-active');
        }, 10);
    }

    function showLoading() {
        document.getElementById('loading-screen').classList.remove('hidden');
        document.getElementById('game-container').classList.add('hidden');
    }

    function hideLoading() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('game-container').classList.remove('hidden');
    }


    // --- 6. FIREBASE & DATA PERSISTENCE ---

    async function initializeFirebase() {
        showLoading();
        
        if (!firebaseConfig) {
             console.error("Firebase config is missing. Using default/volatile state.");
             auth = { currentUser: { uid: crypto.randomUUID() } }; // Mock auth
             userId = auth.currentUser.uid;
             loadCurrentTask();
             updateUI();
             hideLoading();
             return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); 

            let user;
            if (initialAuthToken) {
                user = (await signInWithCustomToken(auth, initialAuthToken)).user;
            } else {
                user = (await signInAnonymously(auth)).user;
            }
            userId = user.uid;

            let isFirstSnapshot = true; // è·Ÿè¸ªæ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡å¿«ç…§åŠ è½½

            // Start listening for real-time updates to the progress
            onSnapshot(doc(db, progressPath(userId)), (docSnapshot) => {
                const oldFuel = userFuel;
                let shouldLoadTask = false;

                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    userFuel = data.fuel || 0;
                    currentLevelIndex = data.currentLevelIndex || 0;
                } else {
                    userFuel = 0;
                    currentLevelIndex = 0;
                    saveProgress(userFuel); // Save initial state
                }

                // 1. æ£€æŸ¥å‡çº§ (runs on subsequent snapshots where fuel increases)
                if (userFuel >= oldFuel) { 
                    checkLevelUp(userFuel);
                }

                // 2. ç¡®å®šæ˜¯å¦éœ€è¦åŠ è½½æ–°ä»»åŠ¡
                const hasLevelChanged = getCurrentGameLevel(oldFuel) !== getCurrentGameLevel(userFuel);

                if (isFirstSnapshot || hasLevelChanged) {
                    shouldLoadTask = true;
                }

                // 3. æ›´æ–° UI
                updateUI();
                
                // 4. åŠ è½½ä»»åŠ¡
                if (shouldLoadTask) {
                    loadCurrentTask();
                }

                // 5. éšè—åŠ è½½ç•Œé¢
                if (isFirstSnapshot) { 
                    isFirstSnapshot = false; 
                    hideLoading();
                }
                
            }, (error) => {
                console.error("Error listening to progress:", error);
                hideLoading();
            });

        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
            showFeedback('âŒ', 'ç³»ç»Ÿé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æ•°æ®æœåŠ¡å™¨ï¼Œæ¸¸æˆè¿›åº¦å¯èƒ½æ— æ³•ä¿å­˜ã€‚', 'danger', 3);
            userId = crypto.randomUUID();
            loadCurrentTask();
            updateUI();
            hideLoading();
        }
    }

    function saveProgress(fuel) {
        if (!db || !userId) return;

        const data = {
            fuel: fuel,
            currentLevelIndex: currentLevelIndex, 
            lastUpdated: new Date()
        };
        
        setDoc(doc(db, progressPath(userId)), data).catch(error => {
            console.error("Error saving progress:", error);
        });
    }

    // 7.1. é‡ç½®æ¸¸æˆï¼ˆåœ¨é€šå…³åè°ƒç”¨ï¼‰
    window.resetGame = function() {
        userFuel = 0;
        currentLevelIndex = 0;
        _lastKnownLevel = 1;

        if (db && userId) {
            saveProgress(0); // é‡ç½® Firestore è¿›åº¦
        }
        
        // å¯ç”¨æŒ‰é’®
        document.getElementById('mic-btn').disabled = false;
        document.getElementById('listen-btn').disabled = false;
        document.getElementById('skip-btn').disabled = false; // å¯ç”¨è·³è¿‡æŒ‰é’®
        
        document.getElementById('feedback-modal').classList.add('hidden');
        updateUI();
        loadCurrentTask();
    }

    function updateUI() {
        document.getElementById('fuel-display').textContent = userFuel;
        const currentLevel = getCurrentGameLevel();
        const levelIndex = currentLevel - 1;
        // ç¡®ä¿ä¸è¶Šç•Œè®¿é—® LEVEL_NAMES
        if (levelIndex < LEVEL_NAMES.length) {
            document.getElementById('level-display').textContent = `${LEVEL_NAMES[levelIndex]} (Level ${currentLevel})`;
        } else {
             // æ¸¸æˆå®Œæˆåçš„æ˜¾ç¤º
             document.getElementById('level-display').textContent = `ç¯çƒè¾¾äºº ğŸ†`;
        }
    }

    // PWA: æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js').then(registration => {
                console.log('Service Worker registration successful with scope: ', registration.scope);
            }).catch(error => {
                console.log('Service Worker registration failed: ', error);
            });
        });
    }

    // --- 7. INITIALIZATION ---

    window.onload = function() {
        // Replace Lucide icons
        lucide.createIcons();
        
        // Initialize Firebase and start game logic
        initializeFirebase();
    }
</script>

</body>
</html>
