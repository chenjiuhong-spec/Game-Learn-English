<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å­¦è‹±è¯­ - ä¸“ä¸ºé•¿è€…è®¾è®¡</title>
    <!-- Load Tailwind CSS CDN for responsive and aesthetic UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX: PWA Meta Tags - Replace failed Service Worker registration with these tags -->
    <!-- These tags enable 'Add to Home Screen' functionality and full-screen display on mobile -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ä¹å­¦è‹±è¯­">
    <meta name="theme-color" content="#03a9f4">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/03a9f4/ffffff?text=EL">

    <style>
        /* Custom CSS: Adjust font sizes for mobile single-page view while maintaining high readability */
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'SimHei', sans-serif;
            background-color: #e0f7fa; /* Very light cyan background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0.5rem; /* Reduced overall page padding */
            padding-top: 1rem;
        }

        /* Adjusted font sizes for mobile screen, still larger than default text */
        .text-xl-plus { font-size: 1.25rem; line-height: 1.75rem; } /* text-xl */
        .text-2xl-plus { font-size: 1.5rem; line-height: 2rem; } /* text-2xl */
        .text-3xl-plus { font-size: 1.875rem; line-height: 2.25rem; } /* text-3xl */
        .text-4xl-plus { font-size: 2.5rem; line-height: 3rem; } /* text-4xl */
        
        /* Adjusted size for giant emojis in modal */
        .text-emoji-giant { 
            font-size: 5rem; /* ~80px */
            line-height: 1;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8); 
        }

        /* Hide scrollbars but allow scrolling */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom button style for interaction feedback */
        .action-button {
            transition: transform 0.1s;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); 
        }
        .action-button:active {
            transform: scale(0.95);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* Modal background overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 50;
        }

        /* Confetti effect for level up */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 100;
        }
        .confetti-piece {
            position: absolute;
            width: 8px; /* Reduced size */
            height: 16px; 
            background-color: #ffc107; 
            opacity: 0;
            transform-origin: 50% 50%;
            animation: fall 10s linear infinite;
        }
        @keyframes fall {
            0% { opacity: 1; transform: translate(var(--x, 0), -100px) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--x, 0), 100vh) rotate(720deg); }
        }

    </style>
</head>
<body class="bg-blue-50">
    <div id="app" class="w-full max-w-lg flex flex-col items-center">

        <!-- Top Info Bar: Level and Score -->
        <div class="flex justify-between w-full p-2 mb-3 rounded-xl bg-white shadow-lg">
            
            <!-- Level Display -->
            <div class="flex items-center space-x-2 bg-blue-100 p-2 rounded-xl shadow-inner">
                <span id="level-icon" class="text-2xl-plus">ğŸ </span>
                <div class="flex flex-col">
                    <span class="text-xl-plus font-bold text-gray-700">ç¬¬ <span id="current-level-num">1</span> çº§</span>
                    <span id="level-name" class="text-2xl-plus font-extrabold text-blue-700">å®¶å±…åŸºç¡€</span>
                </div>
            </div>

            <!-- Score/Fuel Display -->
            <div class="flex items-center space-x-2 bg-red-100 p-2 rounded-xl shadow-inner">
                <span class="text-2xl-plus">ğŸ”¥</span>
                <div class="flex flex-col items-end">
                    <span class="text-xl-plus font-bold text-gray-700">ç‡ƒæ–™/ç§¯åˆ†</span>
                    <span id="score-display" class="text-2xl-plus font-extrabold text-red-700">0</span>
                </div>
            </div>
        </div>

        <!-- Main Learning Card -->
        <div class="w-full bg-white p-4 rounded-3xl shadow-2xl flex flex-col items-center space-y-4 mb-4">
            <p class="text-xl-plus font-semibold text-gray-800 self-start">å¤§å£°è¯»å‡ºæ­£ç¡®çš„è‹±æ–‡ï¼š</p>

            <!-- English Sentence and Listen Button Container -->
            <div class="w-full bg-blue-600 p-4 rounded-2xl shadow-inner flex flex-col items-center space-y-3 text-center">
                <span id="english-text" class="text-4xl-plus font-black text-white leading-snug">Hello</span>
                
                <!-- Status Bar -->
                <p id="speech-status" class="text-xl-plus font-bold text-yellow-300 hidden">ç‚¹æˆ‘è¯´è¯</p>

                <!-- Listen Standard Pronunciation Button (Font size is text-2xl-plus) -->
                <button onclick="handleTTS()" class="action-button flex items-center justify-center space-x-2 bg-blue-800 text-white py-2 px-4 rounded-full w-full max-w-xs transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 3v14a1 1 0 01-1.707.707L6.683 15H4a1 1 0 01-1-1V6a1 1 0 011-1h2.683l2.21-2.21A1 1 0 019.383 3.076zM12 7a1 1 0 000 6.945A7.001 7.001 0 0015.42 10 7.001 7.001 0 0012 7z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-2xl-plus font-bold">æ”¶å¬æ ‡å‡†å‘éŸ³</span>
                </button>
            </div>

            <!-- Chinese Translation -->
            <p id="chinese-translation" class="text-3xl-plus font-bold text-gray-600 pt-1">ä½ å¥½</p>
        </div>
        
        <!-- Speak Button (Red circle) -->
        <button id="speak-button" onclick="handleSpeechRecognition()" class="action-button flex flex-col items-center justify-center bg-red-600 text-white w-32 h-32 rounded-full transition duration-300 ease-in-out hover:bg-red-700 active:bg-red-800 shadow-2xl mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd" />
                <path fill-rule="evenodd" d="M12 6.5a1 1 0 01-2 0v2a1 1 0 012 0v-2zm-2-4a5 5 0 00-5 5v2.383a1 1 0 01-.894.894L4 12v3h12v-3l-1.106-1.106a1 1 0 01-.894-.894V7.5a5 5 0 00-5-5zM14 15.5a1 1 0 100-2 1 1 0 000 2zM6 15.5a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <span class="text-xl-plus font-bold mt-1">ç‚¹æˆ‘è¯´è¯</span>
        </button>

        <!-- Skip Button (Grey) -->
        <button id="skip-button" onclick="skipQuestion()" class="action-button flex items-center space-x-1 text-gray-500 py-1 px-3 rounded-full transition duration-150 ease-in-out hover:bg-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="text-xl-plus font-semibold">è·³è¿‡è¿™ä¸€é¢˜ (ä¸ç»™ç§¯åˆ†)</span>
        </button>

        <!-- Modal Container -->
        <div id="modal-container"></div>
        
        <!-- Confetti Container -->
        <div id="confetti-container" class="confetti"></div>
    </div>

    <script>
        // =================================================================
        // PWA SETUP (å®ç°å¯å®‰è£…å’Œç±»AppåŠŸèƒ½)
        // -----------------------------------------------------------------
        // å…³é”®ä¿®å¤: ç§»é™¤ Service Worker åŠ¨æ€æ³¨å†Œï¼Œå› ä¸ºå½“å‰ç¯å¢ƒåè®®ä¸æ”¯æŒ (Blob/Data URL)
        // ä»…ä¿ç•™äº†åŸºç¡€ PWA å…ƒæ ‡ç­¾ï¼Œä»¥å®ç°â€œæ·»åŠ åˆ°ä¸»å±å¹•â€æ—¶çš„å…¨å±å’ŒAppå¤–è§‚ã€‚
        // =================================================================

        /**
         * æ³¨å†Œ PWA çš„é€»è¾‘ã€‚
         * ç”±äºç¯å¢ƒé™åˆ¶ï¼Œä¸å†å°è¯•æ³¨å†Œ Service Workerï¼Œä»…ä¾èµ– `<meta>` æ ‡ç­¾ã€‚
         */
        function registerPWA() {
            // åœ¨ HTML å¤´éƒ¨ç›´æ¥æ·»åŠ äº† <meta> æ ‡ç­¾ï¼Œæ­¤å¤„ä»…ä½œæç¤º
            console.warn('PWA: Service Worker æ³¨å†Œé€»è¾‘å·²ç§»é™¤ï¼Œå› ä¸ºå®ƒåœ¨å½“å‰æ²™ç›’ç¯å¢ƒä¸­å› åè®®é™åˆ¶è€Œå¤±è´¥ã€‚');
            console.log('PWA: å·²é€šè¿‡ HTML <meta> æ ‡ç­¾å®ç°â€œæ·»åŠ åˆ°ä¸»å±å¹•â€çš„åŸºæœ¬ App å¤–è§‚ã€‚');
        }

        // ç«‹å³è¿è¡Œ PWA æ³¨å†Œé€»è¾‘
        registerPWA();


        // =================================================================
        // Game Configuration and Data
        // =================================================================
        
        const SCORE_TO_LEVEL_UP = 200; // Score required for level up
        const MAX_LEVEL = 6; // Maximum game level 

        const LEVEL_DATA = {
            1: { 
                name: "å®¶å±…åŸºç¡€", 
                icon: "ğŸ ", 
                score: 10,
                // Level 1: Home Basics (50 words)
                sentences: [
                    ["Door", "é—¨"], ["Window", "çª—æˆ·"], ["Chair", "æ¤…å­"], ["Table", "æ¡Œå­"], ["Sofa", "æ²™å‘"],
                    ["Bed", "åºŠ"], ["Lamp", "ç¯"], ["Book", "ä¹¦"], ["Clock", "æ—¶é’Ÿ"], ["Wall", "å¢™"],
                    ["Floor", "åœ°æ¿"], ["Rug", "åœ°æ¯¯"], ["Kitchen", "å¨æˆ¿"], ["Bedroom", "å§å®¤"], ["Bathroom", "å«ç”Ÿé—´"],
                    ["Stove", "ç‚‰å­"], ["Fridge", "å†°ç®±"], ["Plate", "ç›˜å­"], ["Cup", "æ¯å­"], ["Spoon", "å‹ºå­"],
                    ["Fork", "å‰å­"], ["Knife", "åˆ€"], ["Towel", "æ¯›å·¾"], ["Soap", "è‚¥çš‚"], ["Mirror", "é•œå­"],
                    ["Shower", "æ·‹æµ´"], ["Toilet", "é©¬æ¡¶"], ["Pillow", "æ•å¤´"], ["Blanket", "æ¯¯å­"], ["Closet", "è¡£æŸœ"],
                    ["Light", "ç¯"], ["Phone", "ç”µè¯"], ["Key", "é’¥åŒ™"], ["Coat", "å¤–å¥—"], ["Shoes", "é‹å­"],
                    ["TV", "ç”µè§†"], ["Remote", "é¥æ§å™¨"], ["Picture", "å›¾ç‰‡"], ["Plant", "æ¤ç‰©"], ["Heater", "æš–æ°”"],
                    ["Fan", "é£æ‰‡"], ["Water", "æ°´"], ["Food", "é£Ÿç‰©"], ["Clean", "æ‰“æ‰«"], ["Cook", "çƒ¹é¥ª"],
                    ["Sleep", "ç¡è§‰"], ["Sit", "å"], ["Read", "é˜…è¯»"], ["Walk", "èµ°è·¯"], ["Home", "å®¶"]
                ]
            },
            2: { 
                name: "ç¤¾åŒºäº¤æµ", 
                icon: "ğŸ˜ï¸", 
                score: 15,
                // Level 2: Community Communication (50 short sentences - 3 words max)
                sentences: [
                    ["Hi", "ä½ å¥½"], ["Hello there", "ä½ å¥½"], ["Good morning", "æ—©ä¸Šå¥½"], ["See you", "å†è§"], ["Bye now", "ç°åœ¨å†è§"],
                    ["Thank you", "è°¢è°¢ä½ "], ["You're welcome", "ä¸å®¢æ°”"], ["I'm sorry", "å¯¹ä¸èµ·"], ["Excuse me", "å¯¹ä¸èµ·"], ["Come in", "è¯·è¿›"],
                    ["Sit down", "è¯·å"], ["Be quiet", "è¯·å®‰é™"], ["Yes, please", "æ˜¯çš„ï¼Œè¯·"], ["No, thanks", "ä¸ï¼Œè°¢è°¢"], ["I agree", "æˆ‘åŒæ„"],
                    ["I promise", "æˆ‘ä¿è¯"], ["I quit", "æˆ‘æ”¾å¼ƒ"], ["I know", "æˆ‘çŸ¥é“"], ["I don't know", "æˆ‘ä¸çŸ¥é“"], ["Call me", "ç»™æˆ‘æ‰“ç”µè¯"],
                    ["Help me", "å¸®å¸®æˆ‘"], ["Look out", "å°å¿ƒ"], ["Watch out", "å½“å¿ƒ"], ["It's cold", "å¤©æ°”å†·"], ["It's hot", "å¤©æ°”çƒ­"],
                    ["I'm hungry", "æˆ‘é¥¿äº†"], ["I'm thirsty", "æˆ‘æ¸´äº†"], ["I feel sick", "æˆ‘ç”Ÿç—…äº†"], ["I am fine", "æˆ‘å¾ˆå¥½"], ["I'm happy", "æˆ‘å¾ˆé«˜å…´"],
                    ["I'm tired", "æˆ‘ç´¯äº†"], ["Go ahead", "è¯·å§"], ["Wait here", "åœ¨è¿™é‡Œç­‰"], ["This way", "è¿™è¾¹èµ°"], ["Follow me", "è·Ÿç€æˆ‘"],
                    ["Try again", "å†è¯•ä¸€æ¬¡"], ["Don't worry", "åˆ«æ‹…å¿ƒ"], ["It's true", "è¿™æ˜¯çœŸçš„"], ["Is it true?", "è¿™æ˜¯çœŸçš„å—?"], ["I like it", "æˆ‘å–œæ¬¢å®ƒ"],
                    ["I need it", "æˆ‘éœ€è¦å®ƒ"], ["Come back", "å›æ¥"], ["Let's go", "æˆ‘ä»¬èµ°å§"], ["Take care", "ä¿é‡"], ["Why not?", "ä¸ºä»€ä¹ˆä¸?"],
                    ["What's up?", "æ€ä¹ˆäº†?"], ["Give me", "ç»™æˆ‘"], ["Hurry up", "å¿«ç‚¹"], ["Come here", "è¿‡æ¥"], ["Good night", "æ™šå®‰"]
                ]
            },
         3: { 
                name: "æˆ·å¤–æ´»åŠ¨", 
                icon: "ğŸŒ³", 
                score: 20,
                sentences: [
                    ["The sun is out.", "å¤ªé˜³å‡ºæ¥äº†ã€‚"],
                    ["Let's go outside.", "æˆ‘ä»¬å‡ºå»å§ã€‚"],
                    ["Look at the sky.", "çœ‹å¤©ç©ºã€‚"],
                    ["The park is big.", "å…¬å›­å¾ˆå¤§ã€‚"],
                    ["I see a dog.", "æˆ‘çœ‹åˆ°ä¸€åªç‹—ã€‚"],
                    ["The grass is green.", "è‰æ˜¯ç»¿è‰²çš„ã€‚"],
                    ["I feel the wind.", "æˆ‘æ„Ÿè§‰åˆ°é£ã€‚"],
                    ["We need water.", "æˆ‘ä»¬éœ€è¦æ°´ã€‚"],
                    ["It is very hot.", "å¤©æ°”å¾ˆçƒ­ã€‚"],
                    ["Do you like hiking?", "ä½ å–œæ¬¢å¾’æ­¥å—ï¼Ÿ"],
                    ["Take a deep breath.", "æ·±å‘¼å¸ã€‚"],
                    ["I wear a hat.", "æˆ‘æˆ´ç€ä¸€é¡¶å¸½å­ã€‚"],
                    ["The flowers smell good.", "èŠ±é—»èµ·æ¥å¾ˆé¦™ã€‚"],
                    ["Let's find a bench.", "æˆ‘ä»¬æ‰¾ä¸ªé•¿å‡³å§ã€‚"],
                    ["I love the view.", "æˆ‘å–œæ¬¢è¿™ä¸ªæ™¯è‰²ã€‚"],
                    ["The birds are singing.", "é¸Ÿå„¿åœ¨å”±æ­Œã€‚"],
                    ["This path is easy.", "è¿™æ¡è·¯å¾ˆå®¹æ˜“ã€‚"],
                    ["Be careful now.", "ç°åœ¨è¦å°å¿ƒã€‚"],
                    ["I feel relaxed.", "æˆ‘æ„Ÿè§‰å¾ˆæ”¾æ¾ã€‚"],
                    ["The market is busy.", "å¸‚åœºå¾ˆçƒ­é—¹ã€‚"],
                    ["Let's buy food.", "æˆ‘ä»¬ä¹°é£Ÿç‰©å§ã€‚"],
                    ["I lost my key.", "æˆ‘å¼„ä¸¢äº†æˆ‘çš„é’¥åŒ™ã€‚"],
                    ["Where is the shop?", "å•†åº—åœ¨å“ªé‡Œï¼Ÿ"],
                    ["I am very thirsty.", "æˆ‘éå¸¸æ¸´ã€‚"],
                    ["It might rain.", "å¯èƒ½ä¸‹é›¨ã€‚"],
                    ["The stars shine bright.", "æ˜Ÿæ˜Ÿé—ªè€€ã€‚"],
                    ["Let's watch the sunset.", "æˆ‘ä»¬çœ‹æ—¥è½å§ã€‚"],
                    ["I like this place.", "æˆ‘å–œæ¬¢è¿™ä¸ªåœ°æ–¹ã€‚"],
                    ["Take a photo now.", "ç°åœ¨æ‹å¼ ç…§ç‰‡ã€‚"],
                    ["I see a mountain.", "æˆ‘çœ‹åˆ°ä¸€åº§å±±ã€‚"],
                    ["Is the zoo open?", "åŠ¨ç‰©å›­å¼€é—¨å—ï¼Ÿ"],
                    ["The river is long.", "æ²³å¾ˆé•¿ã€‚"],
                    ["Let's go fishing.", "æˆ‘ä»¬å»é’“é±¼å§ã€‚"],
                    ["I am walking home.", "æˆ‘æ­£åœ¨èµ°è·¯å›å®¶ã€‚"],
                    ["We are almost there.", "æˆ‘ä»¬å¿«åˆ°äº†ã€‚"],
                    ["The museum is free.", "åšç‰©é¦†æ˜¯å…è´¹çš„ã€‚"],
                    ["I need a ticket.", "æˆ‘éœ€è¦ä¸€å¼ ç¥¨ã€‚"],
                    ["Please wait for me.", "è¯·ç­‰æˆ‘ã€‚"],
                    ["I wear good shoes.", "æˆ‘ç©¿ç€å¥½é‹ã€‚"],
                    ["The weather is nice.", "å¤©æ°”å¾ˆå¥½ã€‚"],
                    ["I need a rest.", "æˆ‘éœ€è¦ä¼‘æ¯ã€‚"],
                    ["I am having fun.", "æˆ‘ç©å¾—å¾ˆå¼€å¿ƒã€‚"],
                    ["Let's ride a bike.", "æˆ‘ä»¬éª‘è‡ªè¡Œè½¦å§ã€‚"],
                    ["Look at that tree.", "çœ‹é‚£æ£µæ ‘ã€‚"],
                    ["I love fresh air.", "æˆ‘çˆ±æ–°é²œç©ºæ°”ã€‚"],
                    ["Let's eat lunch.", "æˆ‘ä»¬åƒåˆé¥­å§ã€‚"],
                    ["I feel much better.", "æˆ‘æ„Ÿè§‰å¥½å¤šäº†ã€‚"],
                    ["Let's check the map.", "æˆ‘ä»¬çœ‹çœ‹åœ°å›¾å§ã€‚"],
                    ["What is that sound?", "é‚£æ˜¯ä»€ä¹ˆå£°éŸ³ï¼Ÿ"],
                    ["The city is bright.", "åŸå¸‚å¾ˆæ˜äº®ã€‚"]
                ]
            },
            4: { 
                name: "äº¤é€šå‡ºè¡Œ", 
                icon: "ğŸšŒ", 
                score: 25,
                sentences: [
                    ["Where is the train station?", "ç«è½¦ç«™åœ¨å“ªé‡Œï¼Ÿ"],
                    ["I need a bus ticket.", "æˆ‘éœ€è¦ä¸€å¼ å…¬å…±æ±½è½¦ç¥¨ã€‚"],
                    ["How much is the fare?", "è½¦è´¹æ˜¯å¤šå°‘ï¼Ÿ"],
                    ["Please drive safely.", "è¯·å®‰å…¨é©¾é©¶ã€‚"],
                    ["Turn left at the next light.", "åœ¨ä¸‹ä¸€ä¸ªçº¢ç»¿ç¯å¤„å·¦è½¬ã€‚"],
                    ["Stop here, please.", "è¯·åœåœ¨è¿™é‡Œã€‚"],
                    ["I am going to the airport.", "æˆ‘è¦å»æœºåœºã€‚"],
                    ["Which platform is the train on?", "ç«è½¦åœ¨å“ªä¸ªç«™å°ï¼Ÿ"],
                    ["I need a taxi immediately.", "æˆ‘éœ€è¦ä¸€è¾†å‡ºç§Ÿè½¦ã€‚"],
                    ["Is this seat available?", "è¿™ä¸ªåº§ä½æœ‰äººåå—ï¼Ÿ"],
                    ["I feel carsick.", "æˆ‘æ™•è½¦ã€‚"],
                    ["How long will the ride take?", "è¿™æ¬¡è¡Œç¨‹éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ"],
                    ["I missed the last bus.", "æˆ‘é”™è¿‡äº†æœ€åä¸€ç­å…¬å…±æ±½è½¦ã€‚"],
                    ["Can you take me to this address?", "ä½ èƒ½å¸¦æˆ‘å»è¿™ä¸ªåœ°å€å—ï¼Ÿ"],
                    ["The traffic is very heavy.", "äº¤é€šéå¸¸æ‹¥å µã€‚"],
                    ["The red light means stop.", "çº¢ç¯è¡¨ç¤ºåœæ­¢ã€‚"],
                    ["I need to transfer here.", "æˆ‘éœ€è¦åœ¨è¿™é‡Œæ¢ä¹˜ã€‚"],
                    ["Where are we going now?", "æˆ‘ä»¬ç°åœ¨è¦å»å“ªé‡Œï¼Ÿ"],
                    ["Please use the seat belt.", "è¯·ç³»å¥½å®‰å…¨å¸¦ã€‚"],
                    ["I need a map of the subway.", "æˆ‘éœ€è¦ä¸€å¼ åœ°é“å›¾ã€‚"],
                    ["The car broke down.", "æ±½è½¦æŠ›é”šäº†ã€‚"],
                    ["Is there a parking space?", "æœ‰åœè½¦ä½å—ï¼Ÿ"],
                    ["I need to rent a car.", "æˆ‘éœ€è¦ç§Ÿä¸€è¾†è½¦ã€‚"],
                    ["The journey was long.", "æ—…é€”å¾ˆæ¼«é•¿ã€‚"],
                    ["Please follow the speed limit.", "è¯·éµå®ˆé™é€Ÿã€‚"],
                    ["This lane is for buses only.", "è¿™æ¡è½¦é“åªä¾›å…¬å…±æ±½è½¦ä½¿ç”¨ã€‚"],
                    ["I prefer walking.", "æˆ‘æ›´å–œæ¬¢æ­¥è¡Œã€‚"],
                    ["The ticket machine is broken.", "å”®ç¥¨æœºåäº†ã€‚"],
                    ["I need to validate my ticket.", "æˆ‘éœ€è¦æ£€ç¥¨ã€‚"],
                    ["The destination is far away.", "ç›®çš„åœ°å¾ˆè¿œã€‚"],
                    ["I need to check the timetable.", "æˆ‘éœ€è¦æŸ¥çœ‹æ—¶é—´è¡¨ã€‚"],
                    ["Which exit should I take?", "æˆ‘åº”è¯¥èµ°å“ªä¸ªå‡ºå£ï¼Ÿ"],
                    ["I lost my luggage.", "æˆ‘ä¸¢å¤±äº†æˆ‘çš„è¡Œæã€‚"],
                    ["Is this the right direction?", "è¿™æ˜¯æ­£ç¡®çš„æ–¹å‘å—ï¼Ÿ"],
                    ["I am waiting for a connection.", "æˆ‘æ­£åœ¨ç­‰å€™è½¬æœºã€‚"],
                    ["Be careful when crossing the road.", "è¿‡é©¬è·¯æ—¶è¦å°å¿ƒã€‚"],
                    ["The bridge is closed.", "è¿™åº§æ¡¥å…³é—­äº†ã€‚"],
                    ["I will take the next stop.", "æˆ‘å°†åœ¨ä¸‹ä¸€ç«™ä¸‹è½¦ã€‚"],
                    ["How do I get to the city center?", "æˆ‘å¦‚ä½•åˆ°è¾¾å¸‚ä¸­å¿ƒï¼Ÿ"],
                    ["The driver was very friendly.", "å¸æœºéå¸¸å‹å¥½ã€‚"],
                    ["I need a round-trip ticket.", "æˆ‘éœ€è¦ä¸€å¼ å¾€è¿”ç¥¨ã€‚"],
                    ["I bought my ticket online.", "æˆ‘åœ¨ç½‘ä¸Šä¹°äº†ç¥¨ã€‚"],
                    ["Is there a discount for seniors?", "è€å¹´äººæœ‰æŠ˜æ‰£å—ï¼Ÿ"],
                    ["The road is very slippery.", "è·¯é¢å¾ˆæ»‘ã€‚"],
                    ["I see the sign now.", "æˆ‘ç°åœ¨çœ‹åˆ°æ ‡å¿—äº†ã€‚"],
                    ["I must be on time.", "æˆ‘å¿…é¡»å‡†æ—¶ã€‚"],
                    ["The ship is leaving soon.", "èˆ¹å¾ˆå¿«å°±è¦ç¦»å¼€äº†ã€‚"],
                    ["I need assistance with my bags.", "æˆ‘çš„è¡Œæéœ€è¦å¸®åŠ©ã€‚"],
                    ["Please watch your step.", "è¯·æ³¨æ„è„šä¸‹ã€‚"],
                    ["I am going straight ahead.", "æˆ‘ç›´èµ°ã€‚"]
                ]
            },
            5: { 
                name: "ç´§æ€¥æ±‚åŠ©", 
                icon: "ğŸš¨", 
                score: 30,
                sentences: [
                    ["Help! Call the police!", "æ•‘å‘½ï¼å«è­¦å¯Ÿï¼"],
                    ["I need an ambulance now.", "æˆ‘ç°åœ¨éœ€è¦ä¸€è¾†æ•‘æŠ¤è½¦ã€‚"],
                    ["I am hurt and cannot move.", "æˆ‘å—ä¼¤äº†ï¼Œä¸èƒ½åŠ¨ã€‚"],
                    ["There is a fire in the building.", "å¤§æ¥¼é‡Œç€ç«äº†ã€‚"],
                    ["I am lost and cannot find my way.", "æˆ‘è¿·è·¯äº†ï¼Œæ‰¾ä¸åˆ°è·¯ã€‚"],
                    ["I need a doctor immediately.", "æˆ‘éœ€è¦ç«‹åˆ»çœ‹åŒ»ç”Ÿã€‚"],
                    ["What is the emergency number?", "ç´§æ€¥ç”µè¯å·ç æ˜¯å¤šå°‘ï¼Ÿ"],
                    ["I have fallen down.", "æˆ‘æ‘”å€’äº†ã€‚"],
                    ["Can you call my daughter?", "ä½ èƒ½ç»™æˆ‘å¥³å„¿æ‰“ç”µè¯å—ï¼Ÿ"],
                    ["I feel very sick.", "æˆ‘æ„Ÿè§‰å¾ˆä¸èˆ’æœã€‚"],
                    ["Please stay with me.", "è¯·å’Œæˆ‘å¾…åœ¨ä¸€èµ·ã€‚"],
                    ["I need water and shelter.", "æˆ‘éœ€è¦æ°´å’Œä½æ‰€ã€‚"],
                    ["Where is the nearest hospital?", "æœ€è¿‘çš„åŒ»é™¢åœ¨å“ªé‡Œï¼Ÿ"],
                    ["I have chest pain.", "æˆ‘èƒ¸å£ç—›ã€‚"],
                    ["My head hurts badly.", "æˆ‘å¤´å¾ˆç–¼ã€‚"],
                    ["Someone stole my bag.", "æœ‰äººå·äº†æˆ‘çš„åŒ…ã€‚"],
                    ["Please hurry!", "è¯·å¿«ç‚¹ï¼"],
                    ["I cannot breathe well.", "æˆ‘å‘¼å¸ä¸é¡ºç•…ã€‚"],
                    ["Is anyone a nurse or doctor?", "æœ‰äººæ˜¯æŠ¤å£«æˆ–åŒ»ç”Ÿå—ï¼Ÿ"],
                    ["I need help crossing the street.", "æˆ‘è¿‡é©¬è·¯éœ€è¦å¸®åŠ©ã€‚"],
                    ["My car broke down on the road.", "æˆ‘çš„è½¦åœ¨è·¯ä¸ŠæŠ›é”šäº†ã€‚"],
                    ["I need to report an accident.", "æˆ‘éœ€è¦æŠ¥å‘Šä¸€èµ·äº‹æ•…ã€‚"],
                    ["Is there a safe place to wait?", "æœ‰æ²¡æœ‰ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹å¯ä»¥ç­‰å¾…ï¼Ÿ"],
                    ["I need my medication.", "æˆ‘éœ€è¦æˆ‘çš„è¯ã€‚"],
                    ["I feel dizzy.", "æˆ‘æ„Ÿåˆ°å¤´æ™•ã€‚"],
                    ["I need to sit down.", "æˆ‘éœ€è¦åä¸‹ã€‚"],
                    ["My vision is blurry.", "æˆ‘çš„è§†åŠ›æ¨¡ç³Šã€‚"],
                    ["I am having an allergic reaction.", "æˆ‘æ­£åœ¨è¿‡æ•ã€‚"],
                    ["Please don't leave me alone.", "è¯·ä¸è¦ç•™ä¸‹æˆ‘ä¸€ä¸ªäººã€‚"],
                    ["I need to contact the embassy.", "æˆ‘éœ€è¦è”ç³»å¤§ä½¿é¦†ã€‚"],
                    ["The door is stuck.", "é—¨å¡ä½äº†ã€‚"],
                    ["I can't reach my keys.", "æˆ‘å¤Ÿä¸åˆ°æˆ‘çš„é’¥åŒ™ã€‚"],
                    ["I need directions to a police station.", "æˆ‘éœ€è¦å»è­¦å¯Ÿå±€çš„è·¯çº¿ã€‚"],
                    ["Please secure the area.", "è¯·ä¿æŠ¤å¥½è¿™ä¸ªåŒºåŸŸã€‚"],
                    ["I have a severe fever.", "æˆ‘æœ‰ä¸¥é‡çš„ä½çƒ§ã€‚"],
                    ["I am bleeding badly.", "æˆ‘æµè¡€å¾ˆä¸¥é‡ã€‚"],
                    ["Did anyone see what happened?", "æœ‰äººçœ‹åˆ°å‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿ"],
                    ["I lost my wallet.", "æˆ‘ä¸¢äº†é’±åŒ…ã€‚"],
                    ["I need food and warmth.", "æˆ‘éœ€è¦é£Ÿç‰©å’Œæ¸©æš–ã€‚"],
                    ["My phone is dead.", "æˆ‘çš„æ‰‹æœºæ²¡ç”µäº†ã€‚"],
                    ["I need a blanket.", "æˆ‘éœ€è¦ä¸€æ¡æ¯¯å­ã€‚"],
                    ["The road is blocked.", "é“è·¯è¢«å µä½äº†ã€‚"],
                    ["Is the situation under control?", "æƒ…å†µå¾—åˆ°æ§åˆ¶äº†å—ï¼Ÿ"],
                    ["I need a ride to the clinic.", "æˆ‘éœ€è¦æ­è½¦å»è¯Šæ‰€ã€‚"],
                    ["I am feeling weak.", "æˆ‘æ„Ÿåˆ°è™šå¼±ã€‚"],
                    ["I have a burn injury.", "æˆ‘çƒ§ä¼¤äº†ã€‚"],
                    ["Please call for technical support.", "è¯·å‘¼å«æŠ€æœ¯æ”¯æŒã€‚"],
                    ["My leg is broken.", "æˆ‘çš„è…¿æ–­äº†ã€‚"],
                    ["Is everything alright?", "ä¸€åˆ‡éƒ½å¥½å—ï¼Ÿ"],
                    ["I need to check out.", "æˆ‘éœ€è¦é€€æˆ¿ã€‚"]
                ]
            },
            6: { 
                name: "ç¯çƒè¾¾äºº", 
                icon: "âœˆï¸", 
                score: 30, 
                sentences: [
                    ["I would like to confirm my reservation.", "æˆ‘æƒ³ç¡®è®¤æˆ‘çš„é¢„è®¢ã€‚"],
                    ["Could you please print the boarding pass?", "æ‚¨èƒ½æ‰“å°ç™»æœºç‰Œå—ï¼Ÿ"],
                    ["What is the exchange rate today?", "ä»Šå¤©çš„æ±‡ç‡æ˜¯å¤šå°‘ï¼Ÿ"],
                    ["I am here on a business trip.", "æˆ‘æ¥è¿™é‡Œå‡ºå·®ã€‚"],
                    ["Thank you for your cooperation.", "è°¢è°¢æ‚¨çš„åˆä½œã€‚"],
                    ["I need to renew my passport.", "æˆ‘éœ€è¦æ›´æ–°æˆ‘çš„æŠ¤ç…§ã€‚"],
                    ["Where can I find the customs office?", "æˆ‘åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°æµ·å…³åŠå…¬å®¤ï¼Ÿ"],
                    ["This is a fantastic opportunity.", "è¿™æ˜¯ä¸€ä¸ªç»ä½³çš„æœºä¼šã€‚"],
                    ["I look forward to our meeting.", "æˆ‘æœŸå¾…ç€æˆ‘ä»¬çš„ä¼šé¢ã€‚"],
                    ["Please let me know if you have any questions.", "å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚"]
                ]
            }
        };

        // =================================================================
        // UI Element References
        // =================================================================
        const DOMElements = {
            levelName: document.getElementById('level-name'),
            levelNum: document.getElementById('current-level-num'),
            levelIcon: document.getElementById('level-icon'),
            scoreDisplay: document.getElementById('score-display'),
            englishText: document.getElementById('english-text'),
            chineseTranslation: document.getElementById('chinese-translation'),
            speechStatus: document.getElementById('speech-status'),
            speakButton: document.getElementById('speak-button'),
            skipButton: document.getElementById('skip-button'),
            modalContainer: document.getElementById('modal-container'),
            confettiContainer: document.getElementById('confetti-container')
        };

        // =================================================================
        // Game State Management
        // =================================================================
        let game = {
            currentLevel: 1,
            score: 0,
            levelScore: 0,
            sentences: [], // Stores all [English, Chinese] sentences for the current Level
            usedIndices: new Set(), // Stores indices of used sentences to avoid repetition
            currentSentence: null,
            recognition: null, // SpeechRecognition instance
            isSpeaking: false, // Prevents multiple TTS clicks
            isGameActive: false,
        };

        /**
         * Calculates the current required level based on the total score.
         */
        function deriveCurrentLevel(score) {
            // Ensure score is non-negative
            score = Math.max(0, score); 
            // Level is floor(score / SCORE_TO_LEVEL_UP) + 1, minimum 1
            return Math.max(1, Math.floor(score / SCORE_TO_LEVEL_UP) + 1);
        }

        // =================================================================
        // Game Core Logic
        // =================================================================

        /**
         * Initializes or restarts the game.
         */
        function initGame(score = 0) {
            game.score = score; // Start with specified score (e.g., 0 for new game)
            game.currentLevel = deriveCurrentLevel(game.score); // Calculate starting level
            game.isGameActive = true;
            DOMElements.scoreDisplay.textContent = game.score;
            
            // Handle case where score implies a level beyond MAX_LEVEL at start
            if (game.currentLevel > MAX_LEVEL) {
                 handleGameOver();
                 return;
            }
            
            loadLevel();
        }

        /**
         * Loads the configuration and the first sentence for the current level.
         */
        function loadLevel() {
            if (game.currentLevel > MAX_LEVEL) {
                handleGameOver();
                return;
            }

            const levelData = LEVEL_DATA[game.currentLevel];
            game.sentences = [...levelData.sentences];
            game.usedIndices = new Set();
            
            game.levelScore = game.score % SCORE_TO_LEVEL_UP; // Progress within the current level

            // Update UI
            DOMElements.levelName.textContent = levelData.name;
            DOMElements.levelNum.textContent = game.currentLevel;
            DOMElements.levelIcon.textContent = levelData.icon;
            
            // Ensure Speak and Skip buttons are enabled
            DOMElements.speakButton.classList.remove('opacity-50', 'pointer-events-none');
            DOMElements.skipButton.classList.remove('opacity-50', 'pointer-events-none');
            
            loadNewSentence();
        }

        /**
         * Loads a random, unused sentence.
         */
        function loadNewSentence() {
            if (game.usedIndices.size === game.sentences.length) {
                // All sentences in the current Level are done
                checkLevelUp(true);
                return;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * game.sentences.length);
            } while (game.usedIndices.has(randomIndex));

            game.usedIndices.add(randomIndex);
            game.currentSentence = game.sentences[randomIndex];

            DOMElements.englishText.textContent = game.currentSentence[0];
            DOMElements.chineseTranslation.textContent = game.currentSentence[1];
        }

        /**
         * Increases score and checks for level up.
         * @param {number} points - Points earned.
         * @returns {boolean} - True if level up or game over occurred.
         */
        function gainScore(points) {
            game.score += points;
            game.levelScore = game.score % SCORE_TO_LEVEL_UP; 
            DOMElements.scoreDisplay.textContent = game.score;
            
            // Check for level up after scoring
            return checkLevelUp();
        }

        /**
         * Checks if the level up condition has been met.
         * @param {boolean} forceLevelUp - Force level up (when all sentences are completed).
         * @returns {boolean} - True if level up or game over occurred.
         */
        function checkLevelUp(forceLevelUp = false) {
            const requiredLevel = deriveCurrentLevel(game.score); 
            let didAction = false; // Track if levelUp or gameOver happened

            // 1. Check if score triggers level up
            if (requiredLevel > game.currentLevel || forceLevelUp && game.currentLevel < MAX_LEVEL) {
                const oldLevel = game.currentLevel;
                // è¿™é‡Œçš„ Math.min(MAX_LEVEL, ...) ç¡®ä¿äº†å³ä½¿ requiredLevel è¶…è¿‡ MAX_LEVELï¼Œ
                // game.currentLevel ä¹Ÿåªä¼šæ›´æ–°åˆ° MAX_LEVELï¼Œå¹¶åªæ˜¾ç¤º MAX_LEVEL çš„å‡çº§ã€‚
                // requiredLevel > game.currentLevel çš„åˆ¤æ–­ç¡®ä¿äº†å¦‚æœåˆ†æ•°è¶³ä»¥å‡æ›´å¤šçº§ï¼Œä¹Ÿä¼šè§¦å‘å‡çº§ã€‚
                game.currentLevel = Math.min(MAX_LEVEL, requiredLevel > game.currentLevel ? requiredLevel : game.currentLevel + 1);
                
                if (game.currentLevel > oldLevel) {
                    // Show Level Up modal and schedule next level loading
                    showModal('levelUp', {
                        // ä½¿ç”¨ game.currentLevel ç¡®ä¿è·å–æ­£ç¡®çš„æ•°æ®ï¼Œç°åœ¨æœ€é«˜åˆ° LEVEL_DATA[6]
                        level: game.currentLevel,
                        name: LEVEL_DATA[game.currentLevel].name 
                    });
                    
                    // Delay loading of new Level for Confetti/PopUp duration (10 seconds)
                    setTimeout(() => {
                        loadLevel();
                    }, 10000); 
                    didAction = true;
                }
            }
            
            // 2. Check if maximum level is reached
            // å¦‚æœ currentLevel è¾¾åˆ° MAX_LEVEL (6) å¹¶ä¸” (åˆ†æ•°å·²è§¦å‘ didAction æˆ–æ‰€æœ‰å•è¯å·²å®Œæˆ forceLevelUp)
            if (game.currentLevel >= MAX_LEVEL && (didAction || forceLevelUp)) {
                handleGameOver();
                didAction = true;
            }
            
            return didAction; // Return whether a major state change occurred
        }


        /**
         * Handles the Game Over state.
         */
        function handleGameOver() {
            game.isGameActive = false;
            showModal('gameOver', { finalScore: game.score });
            
            // Disable Speak and Skip buttons
            DOMElements.speakButton.classList.add('opacity-50', 'pointer-events-none');
            DOMElements.skipButton.classList.add('opacity-50', 'pointer-events-none');
        }

        // =================================================================
        // Speech Functionality (TTS and Recognition)
        // =================================================================

        /**
         * Handles standard pronunciation playback (TTS).
         */
        function handleTTS() {
            if (game.isSpeaking) return;
            const text = game.currentSentence[0];
            
            if ('speechSynthesis' in window) {
                game.isSpeaking = true;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; // Set to English
                utterance.pitch = 1.0;
                utterance.rate = 0.8; // Slightly slower for elderly users
                utterance.volume = 1.0;

                utterance.onend = () => { game.isSpeaking = false; };
                utterance.onerror = (e) => {
                    game.isSpeaking = false;
                    console.error('TTS Error:', e);
                    showModal('info', { title: "å‘éŸ³é”™è¯¯", message: "æŠ±æ­‰ï¼Œæ‚¨çš„è®¾å¤‡æ— æ³•æ’­æ”¾æ ‡å‡†å‘éŸ³ã€‚" });
                };

                speechSynthesis.speak(utterance);
            } else {
                showModal('info', { title: "åŠŸèƒ½å—é™", message: "æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½ã€‚" });
            }
        }

        /**
         * Initiates speech recognition.
         */
        function handleSpeechRecognition() {
            const targetText = game.currentSentence[0];
            const currentScore = LEVEL_DATA[game.currentLevel].score;

            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                showModal('info', { title: "åŠŸèƒ½å—é™", message: "æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥åŠŸèƒ½ã€‚" });
                return;
            }

            if (game.recognition) {
                game.recognition.stop();
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            game.recognition = new SpeechRecognition();
            game.recognition.lang = 'en-US'; // Recognize English
            game.recognition.interimResults = false;
            game.recognition.maxAlternatives = 1;

            DOMElements.speechStatus.textContent = "ğŸ”Š æ­£åœ¨å¬... è¯·å¤§å£°è¯»å‡ºè‹±æ–‡";
            DOMElements.speechStatus.classList.remove('hidden');
            DOMElements.speakButton.classList.add('bg-yellow-500', 'animate-pulse');

            game.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                // Basic cleaning for comparison (removing punctuation, lowercasing)
                const cleanTranscript = transcript.toLowerCase().replace(/[.,!?'"]+/g, '');
                const cleanTarget = targetText.toLowerCase().replace(/[.,!?'"]+/g, '');
                
                // For single words, we can also check if the recognized word is *contained* // within the target, to allow for minor speech recognition errors, but for accuracy, 
                // we'll stick to a strict comparison on the cleaned text.
                if (cleanTranscript === cleanTarget) {
                    // Correct pronunciation
                    const didLevelUpOrEnd = gainScore(currentScore); 
                    
                    if (!didLevelUpOrEnd) {
                        // Show success feedback if no level up occurred
                        showModal('feedback', { 
                            success: true, 
                            score: currentScore 
                        });
                    }
                    // If level up occurred, checkLevelUp already handles the LevelUp modal and loadLevel scheduling
                    
                } else {
                    // Incorrect pronunciation
                    showModal('feedback', { 
                        success: false, 
                        recognizedText: transcript 
                    });
                }
            };

            game.recognition.onerror = (event) => {
                console.error('Recognition Error:', event.error);
                
                let errorMessage;
                if (event.error === 'no-speech') {
                    errorMessage = "æœªæ£€æµ‹åˆ°è¯­éŸ³ã€‚è¯·å¤§å£°ä¸€ç‚¹ï¼Œå¹¶ç¡®ä¿åœ¨å¬åˆ°â€œæ­£åœ¨å¬â€æç¤ºåç«‹å³å¼€å§‹è®²è¯ã€‚";
                } else if (event.error === 'not-allowed') {
                    errorMessage = "éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·æ£€æŸ¥æ‚¨çš„è®¾å¤‡æˆ–æµè§ˆå™¨è®¾ç½®ï¼Œå…è®¸ä½¿ç”¨éº¦å…‹é£ã€‚";
                } else {
                    errorMessage = "è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™ï¼Œæˆ–æ‚¨çš„å‘éŸ³ä¸å¤Ÿæ¸…æ™°ã€‚é”™è¯¯ä»£ç : " + event.error;
                }
                
                showModal('info', { 
                    title: "è¯†åˆ«å¤±è´¥", 
                    message: errorMessage
                });
            };

            game.recognition.onend = () => {
                // Clean up status and button animation
                DOMElements.speakButton.classList.remove('bg-yellow-500', 'animate-pulse');
                DOMElements.speechStatus.classList.add('hidden');
                DOMElements.speechStatus.textContent = '';
            };

            try {
                game.recognition.start();
            } catch (e) {
                console.error("Recognition start failed:", e);
                showModal('info', { title: "å¯åŠ¨å¤±è´¥", message: "è¯·ç¡®ä¿æ‚¨çš„æµè§ˆå™¨å…è®¸ä½¿ç”¨éº¦å…‹é£ã€‚" });
                DOMElements.speakButton.classList.remove('bg-yellow-500', 'animate-pulse');
                DOMElements.speechStatus.classList.add('hidden'); 
                DOMElements.speechStatus.textContent = '';
            }
        }

        /**
         * Skips the current question (no score awarded).
         * FIX: Ensures the next sentence loads after the user closes the modal.
         */
        function skipQuestion() {
            showModal('info', {
                title: "é¢˜ç›®å·²è·³è¿‡",
                // Updated message to prompt for next action
                message: "æ‚¨é€‰æ‹©äº†è·³è¿‡ã€‚ç‚¹å‡»â€œä¸‹ä¸€ä¸ªâ€ç»§ç»­å­¦ä¹ ï¼",
                actionLabel: "ä¸‹ä¸€ä¸ª", // Custom label for the button
                nextAction: "loadNewSentence" // Custom action to execute on button click
            });
        }

        // =================================================================
        // UI and Modals/Animations
        // =================================================================

        /**
         * Displays a modal window.
         * @param {string} type - Modal type (feedback, levelUp, gameOver, info).
         * @param {object} data - Data required for the modal content.
         */
        function showModal(type, data = {}) {
            DOMElements.modalContainer.innerHTML = ''; // Clear old modal
            let contentHTML = '';
            let title = '';
            let buttonsHTML = '';
            const isSuccess = data.success === true;
            let duration = 3000; // Default duration

            if (type === 'feedback') {
                if (isSuccess) {
                    title = "ğŸ‰ å‘éŸ³å®Œç¾ï¼";
                    contentHTML = `<p class="text-3xl-plus font-bold text-green-700 mt-4">å¥–åŠ± +${data.score} ç§¯åˆ†ï¼</p>`;
                    // Success feedback: button closes modal and loads new sentence
                    buttonsHTML = `<button onclick="closeModal(); loadNewSentence()" class="action-button bg-green-600 hover:bg-green-700 text-white p-3 rounded-full text-2xl-plus font-bold w-full">ç»§ç»­å­¦ä¹ </button>`;
                    duration = 0; 
                } else {
                    title = "ğŸ¤” å‘éŸ³æœ‰ç‚¹ä¸å‡†ç¡®";
                    contentHTML = `
                        <p class="text-2xl-plus font-bold text-gray-700 mt-4 mb-3">è¯·å†ä»”ç»†å¬å¬åŸæ–‡å¹¶é‡è¯•ã€‚</p>
                        ${data.recognizedText ? `<p class="text-xl-plus text-red-500">ï¼ˆæ‚¨è¯´çš„æ˜¯: ${data.recognizedText}ï¼‰</p>` : ''}
                    `;
                    // Failure feedback: button closes modal (user retries current sentence)
                    buttonsHTML = `
                        <button onclick="closeModal()" class="action-button bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full text-2xl-plus font-bold w-full mb-3">å†è¯•ä¸€æ¬¡</button>
                        <button onclick="closeModal(); loadNewSentence()" class="action-button bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-full text-2xl-plus font-bold w-full">è·³è¿‡ (ä¸ç»™ç§¯åˆ†)</button>
                    `;
                    duration = 0; 
                }
            } else if (type === 'levelUp') {
                title = "ğŸš€ æ­å–œå‡çº§ï¼";
                contentHTML = `
                    <span class="text-emoji-giant">ğŸ‘</span>
                    <p class="text-3xl-plus font-bold text-purple-700 mt-4">æ‚¨å·²è¾¾åˆ°ç¬¬ ${data.level} çº§: ${data.name}ï¼</p>
                    <p class="text-2xl-plus text-gray-700">éš¾åº¦å·²æå‡ï¼å‘ç¯çƒè¾¾äººè¿ˆè¿›ï¼</p>
                `;
                buttonsHTML = `<!-- Auto close, no button -->`;
                duration = 10000; // 10 seconds duration
                createConfetti(duration); // Start confetti
            } else if (type === 'gameOver') {
                title = "ğŸŒŸ ç¯çƒè¾¾äººï¼æ¸¸æˆèƒœåˆ©ï¼";
                contentHTML = `
                    <span class="text-emoji-giant">ğŸ†</span>
                    <p class="text-3xl-plus font-bold text-green-700 mt-4">æ­å–œæ‚¨ï¼Œå®Œæˆäº†æ‰€æœ‰ç­‰çº§ï¼</p>
                    <p class="text-2xl-plus text-gray-700">æœ€ç»ˆæ€»ç§¯åˆ†ï¼š${data.finalScore}</p>
                `;
                buttonsHTML = `<button onclick="closeModal(); initGame(0);" class="action-button bg-green-600 hover:bg-green-700 text-white p-3 rounded-full text-2xl-plus font-bold w-full">ä»å¤´å†ç©</button>`;
                duration = 10000; // 10 seconds duration
                createConfetti(duration);
            } else if (type === 'info') {
                title = data.title || "æç¤º";
                contentHTML = `<p class="text-2xl-plus font-bold text-gray-700 mt-4">${data.message}</p>`;
                
                // If a specific action (like skipping) is requested
                if (data.nextAction === 'loadNewSentence') {
                    // Button executes closeModal() and loadNewSentence()
                    buttonsHTML = `<button onclick="closeModal(); loadNewSentence()" class="action-button bg-green-600 hover:bg-green-700 text-white p-3 rounded-full text-2xl-plus font-bold w-full">${data.actionLabel || 'å¥½çš„'}</button>`;
                } else {
                    // Default info box behavior: just close
                    buttonsHTML = `<button onclick="closeModal()" class="action-button bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full text-2xl-plus font-bold w-full">å¥½çš„</button>`;
                }
                duration = 0;
            }

            const modalHTML = `
                <div class="modal-overlay fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl text-center animate-in zoom-in duration-500">
                        <h2 class="text-4xl-plus font-extrabold mb-3 text-blue-800">${title}</h2>
                        ${contentHTML}
                        <div class="mt-6">${buttonsHTML}</div>
                    </div>
                </div>
            `;
            DOMElements.modalContainer.innerHTML = modalHTML;
            
            // If automatic closing time is set (only for levelUp and gameOver)
            if (duration > 0 && type !== 'feedback') {
                setTimeout(closeModal, duration);
            }
        }

        /**
         * Closes the modal window.
         */
        function closeModal() {
            DOMElements.modalContainer.innerHTML = '';
            DOMElements.confettiContainer.innerHTML = '';
            
            // Ensure speech recognition listener is cleaned up
            if (game.recognition) {
                game.recognition.stop();
            }
        }

        /**
         * Starts the confetti animation.
         * @param {number} duration - Duration in milliseconds.
         */
        function createConfetti(duration) {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#00bcd4', '#009688', '#4caf50', '#ffeb3b', '#ff9800', '#ff5722'];
            const container = DOMElements.confettiContainer;
            container.innerHTML = '';

            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.setProperty('--x', `${(Math.random() - 0.5) * 200}px`);
                piece.style.animationDelay = `${Math.random() * 10}s`;
                piece.style.animationDuration = `${5 + Math.random() * 5}s`;
                piece.style.width = `${5 + Math.random() * 10}px`;
                piece.style.height = `${10 + Math.random() * 15}px`;
                container.appendChild(piece);
            }

            setTimeout(() => {
                container.innerHTML = '';
            }, duration);
        }

        // =================================================================
        // Initialization
        // =================================================================
        
        // Start the game after the page loads
        window.onload = function() {
            // PWAæ³¨å†Œå·²åœ¨å‰é¢éƒ¨åˆ†å¤„ç†ï¼Œè¿™é‡Œåªéœ€è¦å¯åŠ¨æ¸¸æˆ
            initGame();
        };

    </script>
</body>
</html>

